<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>Rolezinho</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  /* Reset e base mobile-first */
  * {
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
  }
  
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    overscroll-behavior: none;
    -webkit-overflow-scrolling: touch;
    -webkit-text-size-adjust: 100%;
    touch-action: pan-x pan-y;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  }

  body {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  /* Mapa responsivo com safe areas */
  #map {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100vh;
    height: 100dvh;
    width: 100vw;
    z-index: 1;
    touch-action: none;
  }

  /* Popups do mapa otimizados */
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    padding: 8px;
  }

  .thumbnail {
    max-width: 200px;
    max-height: 200px;
    width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 8px 0;
    object-fit: cover;
  }

  /* Bottom bar mobile-first */
  #bottomBar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 12px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    z-index: 1000;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.3s ease;
  }

  #bottomBar.hidden {
    transform: translateY(100%);
  }

  /* Bot√µes otimizados para mobile */
  button {
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 12px;
    border: none;
    background: #0066ff;
    color: white;
    font-weight: 600;
    cursor: pointer;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
    transition: all 0.2s;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  button:active {
    transform: scale(0.95);
    opacity: 0.8;
  }

  button:disabled {
    opacity: 0.4;
    pointer-events: none;
  }

  .btn-secondary {
    background: #333;
    border: 1px solid #555;
  }

  .btn-icon {
    min-width: 44px;
    padding: 10px;
  }

  /* Modais fullscreen mobile */
  .modal-fullscreen {
    position: fixed;
    inset: 0;
    background: #000;
    color: white;
    z-index: 9999;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 24px;
    padding-top: calc(24px + env(safe-area-inset-top, 0px));
    padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  .modal-fullscreen.active {
    display: flex;
  }

  .modal-content {
    max-width: 500px;
    width: 100%;
    text-align: center;
  }

  h1 {
    font-size: clamp(32px, 8vw, 48px);
    margin: 0 0 16px;
    font-weight: 700;
  }

  h2 {
    font-size: clamp(28px, 6vw, 38px);
    margin: 0 0 12px;
    font-weight: 600;
  }

  p {
    font-size: clamp(16px, 4vw, 20px);
    line-height: 1.5;
    opacity: 0.9;
    margin: 12px 0;
  }

  /* Inputs otimizados para mobile */
  input[type="text"],
  input[type="email"],
  input[type="tel"] {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border-radius: 12px;
    border: 2px solid #333;
    background: #111;
    color: white;
    margin: 8px 0;
    -webkit-appearance: none;
    appearance: none;
  }

  input:focus {
    outline: none;
    border-color: #0066ff;
  }

  /* Profile modal adaptado */
  #profileModal {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    color: white;
    z-index: 9999;
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top, 0px));
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  #profileModal.active {
    display: block;
  }

  .profile-photo {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    margin: 16px auto;
    display: block;
  }

  .role-card {
    padding: 16px;
    background: #111;
    border: 1px solid #333;
    border-radius: 12px;
    margin: 12px 0;
  }

  .role-card h3 {
    margin: 0 0 8px;
    font-size: 18px;
  }

  .role-card .date {
    font-size: 14px;
    opacity: 0.7;
    margin-bottom: 12px;
  }

  .button-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .button-group button {
    flex: 1;
    min-width: 100px;
    font-size: 14px;
    padding: 10px 16px;
  }

  /* Story editor mobile */
  #storyEditor {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 9999;
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top, 0px));
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    flex-direction: column;
  }

  #storyEditor.active {
    display: flex;
  }

  #storyCanvasWrapper {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  #storyCanvas {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    border: 2px solid #333;
  }

  /* Loading spinner */
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top-color: #0066ff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Gestos e anima√ß√µes */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Landscape adjustments */
  @media (orientation: landscape) and (max-height: 500px) {
    h1 { font-size: 28px; }
    h2 { font-size: 24px; }
    p { font-size: 16px; }
    button { padding: 10px 16px; min-height: 40px; }
  }

  /* Hide file input */
  input[type="file"] {
    display: none;
  }
</style>
</head>
<body>

<div id="loginScreen" class="modal-fullscreen active" style="display:flex;">
  <div class="modal-content">
    <img src="logo.png" alt="Rolezinho" style="width:120px; margin-bottom:20px;">
    <input id="loginEmail" type="email" placeholder="Email" autocomplete="email">
    <input id="loginPassword" type="password" placeholder="Senha" autocomplete="current-password">
    <button id="loginBtn">Login</button>
    <button id="createAccountBtn" class="btn-secondary" style="margin-top:10px;">Criar conta</button>
  </div>
</div>
<div id="profileModal" class="modal-fullscreen">
  <button id="closeProfile" style="position:absolute; top:20px; right:20px;">‚úï</button>
  <h2>Meu Perfil</h2>
  <img id="profilePhotoPreview" class="profile-photo" style="display:none;">

  <p><strong>Nome:</strong> <span id="profileName"></span></p>
  <p><strong>Username:</strong> <span id="profileUser"></span></p>
  <p><strong>Email:</strong> <span id="profileEmail"></span></p>

  <h3 style="margin-top:30px;">Meus Rol√™s</h3>
  <div id="profileRoles"></div>
</div>

<!-- Map -->
<div id="map"></div>

<div id="bottomTabs" style="
  position:fixed; bottom:0; left:0; right:0;
  height:70px; background:rgba(0,0,0,0.95);
  display:flex; justify-content:space-around; align-items:center;
  border-top:1px solid rgba(255,255,255,0.1); z-index:1000;">
  
  <button id="tabHome" class="btn-secondary" style="flex:1; height:100%;">üè†</button>
  <button id="tabUpload" style="
    position:absolute; bottom:35px; left:50%; transform:translateX(-50%);
    width:70px; height:70px; border-radius:50%; background:#0066ff;
    border:none; font-size:28px; color:white;">Ôºã</button>
  <button id="tabProfile" class="btn-secondary" style="flex:1; height:100%;">üë§</button>
</div>
<input id="uploadInput" type="file" accept="image/*,video/*" multiple style="display:none;">

<!-- Story Editor -->
<div id="storyEditor">
  <button id="closeStoryEditor" style="position: absolute; top: 20px; right: 20px; z-index: 10;">‚úï</button>
  <div id="storyCanvasWrapper">
    <canvas id="storyCanvas" width="1080" height="1920"></canvas>
  </div>
  <button id="exportStory">Exportar Story</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
// Aguardar carregar todos os scripts
// --- Supabase Client (Patch 1) ---
const SUPABASE_URL = 'https://qjanxtpcszdinwxdrmpc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYW54dHBjc3pkaW53eGRybXBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTI2NzUsImV4cCI6MjA3OTE4ODY3NX0.AZUMTReBfk1IR32RCGGZiuR-NpsxzBRkeWItTFCR444';

// Criar o cliente Supabase e expor globalmente como `supabaseClient`
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabaseClient = supabaseClient;

/**
 * uploadThumbnailToSupabase(base64, roleId, filename)
 * - base64: dataURL (ex: 'data:image/jpeg;base64,...')
 * - roleId: uuid da role
 * - filename: nome original do arquivo (usado para gerar o path)
 *
 * Retorna: publicUrl (string) ou lan√ßa erro.
 */
async function uploadThumbnailToSupabase(base64, roleId, filename) {
  try {
    const blob = await (await fetch(base64)).blob();
    const ext = (blob.type && blob.type.split('/')[1]) || 'jpg';
    const safeName = encodeURIComponent(filename.replace(/\s+/g, '_'));
    const path = `${roleId}/${safeName}.${ext}`;

    const { error: uploadError } = await supabaseClient.storage
      .from('thumbnails')
      .upload(path, blob, { contentType: blob.type || 'image/jpeg', upsert: true });

    if (uploadError) throw uploadError;

    const { data } = supabaseClient.storage.from('thumbnails').getPublicUrl(path);
    return data?.publicUrl || null;
  } catch (err) {
    console.error('Erro uploadThumbnailToSupabase:', err);
    throw err;
  }
}

/**
 * createRoleOnSupabase({ titulo, creator_name, creator_photo, profile_id })
 * - Insere uma linha na tabela roles e retorna o objeto inserido.
 */
async function createRoleOnSupabase({ titulo, creator_name, creator_photo, profile_id }) {
  const payload = { titulo, creator_name, creator_photo };
  if (profile_id) payload.profile_id = profile_id;

  const { data, error } = await supabaseClient
    .from('roles')
    .insert(payload)
    .select()
    .single();

  if (error) throw error;
  return data;
}

/**
 * insertWaypointsBulk(roleId, waypointsArray)
 * - waypointsArray: [{ lat, lon, name, thumbnail_url, is_video, ts }]
 * - Insere todos os waypoints para role_id e retorna os registros inseridos.
 */
async function insertWaypointsBulk(roleId, waypointsArray) {
  const payload = waypointsArray.map(w => ({
    role_id: roleId,
    lat: w.lat,
    lon: w.lon,
    name: w.name,
    thumbnail_url: w.thumbnail_url || null,
    is_video: w.is_video || false,
    ts: w.ts || null
  }));

  const { data, error } = await supabaseClient
    .from('waypoints')
    .insert(payload);

  if (error) throw error;
  return data;
}
// --- fim Supabase Client ---

// Login handler and tab logic
document.getElementById("loginBtn").addEventListener("click", async () => {
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) { showToast("Login inv√°lido"); return; }

  document.getElementById("loginScreen").classList.remove("active");
});

document.getElementById("createAccountBtn").addEventListener("click", async () => {
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  const { data, error } = await supabaseClient.auth.signUp({ email, password });
  if (error) { showToast("Erro ao criar conta"); return; }

  showToast("Conta criada! Verifique o email.");
});

document.getElementById("tabUpload").addEventListener("click", () => {
  document.getElementById("uploadInput").click();
});

document.getElementById("tabHome").addEventListener("click", () => {
  document.getElementById("profileModal").classList.remove("active");
});

document.getElementById("tabProfile").addEventListener("click", () => {
  loadProfileData();
  document.getElementById("profileModal").classList.add("active");
});
// --- UX Loading helpers (Patch UX-1) ---
function showLoadingOverlay(message = 'Carregando...') {
  // avoid duplicate
  if (document.getElementById('rx-loading-overlay')) return;
  const overlay = document.createElement('div');
  overlay.id = 'rx-loading-overlay';
  overlay.style.cssText = `
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.6); z-index:100000; color:white; padding:20px; backdrop-filter:blur(6px);
  `;
  overlay.innerHTML = `
    <div style="text-align:center; max-width:320px; width:100%;">
      <div class="spinner" style="margin:0 auto 12px;"></div>
      <div style="font-size:16px; opacity:0.95;">${message}</div>
    </div>
  `;
  document.body.appendChild(overlay);
}

function hideLoadingOverlay() {
  const el = document.getElementById('rx-loading-overlay');
  if (!el) return;
  el.remove();
}
// --- fim UX Loading helpers ---

/* --- UX Toast Helper (Patch UX-2) --- */
function showToast(message) {
  const existing = document.getElementById("rx-toast");
  if (existing) existing.remove();

  const toast = document.createElement("div");
  toast.id = "rx-toast";
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 15px;
    z-index: 999999;
    opacity: 0;
    transition: opacity 0.25s ease, transform 0.25s ease;
  `;
  document.body.appendChild(toast);

  requestAnimationFrame(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateX(-50%) translateY(0)";
  });

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateX(-50%) translateY(10px)";
    setTimeout(() => toast.remove(), 250);
  }, 2200);
}
/* --- fim UX Toast Helper --- */
window.addEventListener('load', function() {
  initApp();
});

function initApp() {
  /* --- C.1: Sync autom√°tico de sess√£o Supabase --- */
  supabaseClient.auth.getSession().then(async ({ data }) => {
    const session = data?.session;
    if (!session || !session.user) return;

    try {
      const { data: profile } = await supabaseClient
        .from("profiles")
        .select("*")
        .eq("auth_uid", session.user.id)
        .single();

      if (profile) {
        window.currentProfile = profile;

        localStorage.setItem("profileId", profile.id || "");
        localStorage.setItem("profileName", profile.name || "");
        localStorage.setItem("profileEmail", profile.email || "");
        localStorage.setItem("profilePhoto", profile.photo_url || "");
        localStorage.setItem("profileUser", profile.username || "");
        localStorage.setItem("profilePhone", profile.phone || "");
      }
    } catch (err) {
      console.error("Erro ao sincronizar sess√£o:", err);
    }
  });
  /* --- fim sync autom√°tico --- */
  // Configura√ß√£o mobile-first
  document.addEventListener('gesturestart', e => e.preventDefault());
  document.addEventListener('gesturechange', e => e.preventDefault());
  document.addEventListener('gestureend', e => e.preventDefault());

  // Mapa
  const map = L.map('map', {
  zoomControl: true,
  attributionControl: false,
  tap: true,
  touchZoom: true,
  scrollWheelZoom: false
}).setView([-27.5954, -48.5480], 13);

L.tileLayer('https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
  detectRetina: true,
  maxZoom: 19
}).addTo(map);

  // Vari√°veis globais
  let waypoints = [];
  let markers = [];
  let currentRoute = null;
  window.map = map; // Tornar acess√≠vel globalmente para fun√ß√µes onclick

  // Autoload shared role
  async function autoloadSharedRole() {
    const roleId = new URLSearchParams(location.search).get("role");
    if (!roleId) return;

    try {
      showLoadingOverlay('Carregando rol√™...');

      const { data: role, error } = await supabaseClient
        .from("roles")
        .select("id, titulo, creator_name, creator_photo")
        .eq("id", roleId)
        .single();

      if (error || !role) {
        console.error("Erro carregando role:", error);
        hideLoadingOverlay();
        return;
      }

      const { data: wps, error: wpsErr } = await supabaseClient
        .from("waypoints")
        .select("*")
        .eq("role_id", roleId)
        .order("ts", { ascending: true });

      if (wpsErr) {
        console.error('Erro carregando waypoints:', wpsErr);
        hideLoadingOverlay();
        return;
      }

      showSharedRoleView({
        titulo: role.titulo,
        creatorName: role.creator_name,
        creatorPhoto: role.creator_photo,
        waypoints: wps || []
      });

      // ensure overlay hides after view is ready
      setTimeout(() => hideLoadingOverlay(), 300);
    } catch (e) {
      console.error("Erro carregando role do Supabase:", e);
      hideLoadingOverlay();
    }
  }

  function showSharedRoleView(roleData) {
    // Carregar waypoints no mapa
    loadRoleData(roleData.waypoints, roleData.titulo);
    
    // Criar header com info do rol√™
    const sharedHeader = document.createElement('div');
    sharedHeader.id = 'sharedHeader';
    sharedHeader.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 12px 16px;
      padding-top: calc(12px + env(safe-area-inset-top, 0px));
      z-index: 1001;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    `;
    
    const creatorName = roleData.creatorName || "Algu√©m";
    const creatorPhoto = roleData.creatorPhoto || "";
    
    sharedHeader.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px; width:100%;">
        ${creatorPhoto ? `<img src="${creatorPhoto}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : `
          <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 20px;">
            üìç
          </div>
        `}
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 16px;">${roleData.titulo || "Rol√™"}</div>
          <div style="font-size: 13px; opacity: 0.7;">por ${creatorName}</div>
        </div>

        <button id="createMyRole" style="background:#0066ff; border:none; color:white; padding:8px 12px; border-radius:8px; font-size:14px; min-height:auto;">
          Criar meu rol√™
        </button>

        <button id="closeSharedView" style="background: transparent; border: none; color: white; font-size: 24px; padding: 4px 8px; min-height: auto;">‚úï</button>
      </div>
    `;
    
    document.body.appendChild(sharedHeader);
    
    // Ajustar mapa para n√£o ficar atr√°s do header
    const mapEl = document.getElementById('map');
    mapEl.style.paddingTop = '64px';
    
    // Esconder bottom bar
    const bottomBar = document.getElementById('bottomBar');
    bottomBar.style.display = 'none';
    
    // Bot√£o para fechar e criar pr√≥prio rol√™
    document.getElementById('closeSharedView').addEventListener('click', () => {
      const newUrl = window.location.origin + window.location.pathname;
      window.history.pushState({}, '', newUrl);
      sharedHeader.remove();
      mapEl.style.paddingTop = '0';
      bottomBar.style.display = 'flex';
      clearMap();
      map.setView([-27.5954, -48.5480], 13);
    });

    // Bot√£o Criar Meu Rol√™
    document.getElementById("createMyRole").addEventListener("click", () => {
      const newUrl = window.location.origin + window.location.pathname;
      window.history.pushState({}, '', newUrl);

      sharedHeader.remove();
      mapEl.style.paddingTop = '0';
      bottomBar.style.display = 'flex';

      clearMap();
      map.setView([-27.5954, -48.5480], 13);

      // abrir upload automaticamente
      document.getElementById("upload").click();
    });
  }

  // Upload de m√≠dias
  document.getElementById("uploadInput").addEventListener("change", async (e) => {
    // (handler logic unchanged, just adapted to uploadInput)
    try {
      // Optionally require auth here if needed
    } catch (err) {
      if (err.message === "auth_required") return;
      console.error(err);
      return;
    }
    const files = Array.from(e.target.files);
    if (!files.length) return;

    // Mostrar loading
    const loadingDiv = document.createElement('div');
    loadingDiv.innerHTML = '<div class="spinner"></div><p style="text-align:center; margin-top:10px;">Processando m√≠dias...</p>';
    loadingDiv.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9998; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white;';
    document.body.appendChild(loadingDiv);

    waypoints = [];
    let ignoredFiles = [];
    clearMap();

    for (let file of files) {
      if (!file.type.startsWith("image")) {
        ignoredFiles.push(file.name + " (somente fotos s√£o permitidas)");
        continue;
      }

      const exif = await window.exifr.gps(file);
      if (exif?.latitude && exif?.longitude) {
        const thumbnail = await fileToBase64(file);
        const ts = exif?.DateTimeOriginal || new Date(file.lastModified);
        
        waypoints.push({
          lat: exif.latitude,
          lon: exif.longitude,
          name: file.name,
          thumbnail,
          isVideo: false,
          ts
        });
      } else {
        ignoredFiles.push(file.name + " (sem localiza√ß√£o GPS)");
      }
    }

    // Mostrar toast para arquivos ignorados
    if (ignoredFiles.length > 0) {
      showToast(ignoredFiles.length + " arquivo(s) ignorado(s)");
    }
    // Ordenar por timestamp
    waypoints.sort((a, b) => new Date(a.ts) - new Date(b.ts));

    // Renderizar no mapa
    renderWaypoints();
    
    document.body.removeChild(loadingDiv);
    // document.getElementById("saveRoute").style.display = "inline-flex";
    
    e.target.value = '';
  });

  function clearMap() {
    // Remove all markers added by the app
    if (markers && markers.length) {
      markers.forEach(m => {
        if (m && map.hasLayer(m)) map.removeLayer(m);
      });
    }
    markers = [];

    // Remove current route if exists
    if (currentRoute && map.hasLayer(currentRoute)) {
      map.removeLayer(currentRoute);
    }
    currentRoute = null;
  }

  function renderWaypoints() {
    clearMap();
    const bounds = [];

    waypoints.forEach((wp, i) => {
      const marker = L.marker([wp.lat, wp.lon]).addTo(map);
      markers.push(marker);

      const mediaHTML = `<img src="${wp.thumbnail}" class="thumbnail">`;

      marker.bindPopup(`
        <div style="text-align:center; min-width:200px;">
          <b>${wp.name}</b><br>
          ${mediaHTML}<br>
          <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
            <button onclick="window.focusMarker(${i - 1})" style="flex:1;">‚¨ÖÔ∏è</button>
            <button onclick="window.focusMarker(${i + 1})" style="flex:1;">‚û°Ô∏è</button>
          </div>
        </div>
      `);

      // Insert popupopen handler before click handler
      marker.on("popupopen", (e) => {
        setTimeout(() => {
          const popup = e.popup._container;
          if (!popup) return;
          const h = popup.offsetHeight;
          map.panBy([0, -h / 2], { animate: true });
        }, 60);
      });

      marker.on("click", () => {
        map.setView(marker.getLatLng(), 15, { animate: false });
        marker.openPopup();
      });

      bounds.push([wp.lat, wp.lon]);
    });

    if (bounds.length > 0) {
      map.once("moveend", () => {
        if (waypoints.length > 1) {
          const coords = waypoints.map(w => `${w.lon},${w.lat}`).join(';');

          fetch(`https://router.project-osrm.org/route/v1/foot/${coords}?overview=full&geometries=geojson`)
            .then(r => r.json())
            .then(data => {
              if (!data || data.code !== "Ok" || !data.routes || data.routes.length === 0) {
                showToast("‚ö†Ô∏è Rota n√£o dispon√≠vel");
                console.warn("OSRM fallback triggered:", data);
                return;
              }
              const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
              if (currentRoute) map.removeLayer(currentRoute);
              currentRoute = L.polyline(routeCoords, {
                color: '#0066ff',
                weight: 4,
                opacity: 0.9
              }).addTo(map);
            })
            .catch(err => {
              console.error("Erro ao carregar rota OSRM:", err);
              showToast("‚ö†Ô∏è Falha ao carregar rota");
            });
        }
      });

      const sharedHeaderEl = document.getElementById("sharedHeader");
      let topPad = 50;

      if (sharedHeaderEl) {
        const rect = sharedHeaderEl.getBoundingClientRect();
        topPad = rect.height + 20; // dynamic header height + small offset
      }

      map.flyToBounds(bounds, {
        paddingTopLeft: [0, topPad],
        paddingBottomRight: [0, 50],
        maxZoom: 15,
        animate: true
      });
    }
    // --- M4: Auto-focus quando h√° apenas 1 waypoint ---
    if (markers.length === 1) {
      const m = markers[0];
      setTimeout(() => {
        map.setView(m.getLatLng(), 16, { animate: true });
        m.openPopup();
      }, 200);
    }
    // --- fim M4 ---
  }

  function loadRoleData(data, title = null) {
    waypoints = data;
    renderWaypoints();
    // Se √© um rol√™ compartilhado, n√£o mostrar bot√£o de compartilhar
    const isShared = new URLSearchParams(window.location.search).has("role");
    if (!isShared) {
      document.getElementById("shareRoute").style.display = "inline-flex";
    }
  }

  // Expor focusMarker globalmente para os bot√µes onclick
  window.focusMarker = function(index) {
    if (!markers.length) return;
    const total = markers.length;
    const i = ((index % total) + total) % total;
    const m = markers[i];
    map.setView(m.getLatLng(), 15, { animate: false });
    m.openPopup();
  };

  // Salvar rol√™
  document.getElementById("saveRoute").addEventListener("click", async () => {
  try {
    if (!waypoints.length) {
      alert("Nenhum rol√™ para salvar.");
      return;
    }

    const titulo = prompt("D√™ um t√≠tulo ao seu rol√™:");
    if (!titulo) return;

    // Criar role no Supabase (com autentica√ß√£o e profile_id)
    const creator_name = window.currentProfile?.name || "An√¥nimo";
    const creator_photo = window.currentProfile?.photo_url || null;

    // Garantir que o usu√°rio esteja autenticado e tenha profile_id
    let profileId = window.currentProfile?.id || localStorage.getItem('profileId');
    if (!profileId) {
      try {
        await requireAuth();
        profileId = window.currentProfile?.id || localStorage.getItem('profileId');
      } catch (err) {
        showToast('√â preciso entrar para salvar rol√™s');
        return;
      }
    }

    const role = await createRoleOnSupabase({
      titulo,
      creator_name,
      creator_photo,
      profile_id: profileId
    });

    const roleId = role.id;

    // Upload das thumbnails + constru√ß√£o do array final
    const waypointsPrepared = [];
    for (let wp of waypoints) {
      let thumbURL = null;

      const compressed = await compressImage(wp.thumbnail, 300);
      thumbURL = await uploadThumbnailToSupabase(compressed, roleId, wp.name);

      waypointsPrepared.push({
        lat: wp.lat,
        lon: wp.lon,
        name: wp.name,
        thumbnail_url: thumbURL,
        is_video: false,
        ts: wp.ts
      });
    }

    // Inserir todos os waypoints de uma vez
    await insertWaypointsBulk(roleId, waypointsPrepared);

    // UI
    alert("Rol√™ salvo com sucesso no Supabase!");
    window.lastSavedRoleId = roleId;

    document.getElementById("shareRoute").style.display = "inline-flex";
    document.getElementById("saveRoute").disabled = true;

  } catch (err) {
    console.error(err);
    alert("Erro ao salvar o rol√™ üò¢ ‚Äî veja o console.");
  }
});
  // Profile
  function loadProfileData() {
    const p = window.currentProfile || {};
    document.getElementById("profileName").textContent = p.name || "‚Äî";
    document.getElementById("profileUser").textContent = p.username ? ("@" + p.username) : "‚Äî";
    document.getElementById("profileEmail").textContent = p.email || "‚Äî";
    const photo = window.currentProfile?.photo_url || localStorage.getItem("profilePhoto");
    const preview = document.getElementById("profilePhotoPreview");
    if (photo) {
      preview.src = photo;
      preview.style.display = "block";
    } else {
      preview.style.display = "none";
    }
    renderProfileRoles();
  }

  document.getElementById("closeProfile").addEventListener("click", () => {
    document.getElementById("profileModal").classList.remove("active");
  });

  async function renderProfileRoles() {
    const pid = window.currentProfile?.id;
    if (!pid) {
      document.getElementById("profileRoles").innerHTML =
        '<p style="text-align:center; opacity:0.5;">Crie um rol√™ para aparecer aqui</p>';
      return;
    }

    const { data: roles } = await supabaseClient
      .from("roles")
      .select("id, titulo, created_at")
      .eq("profile_id", pid)
      .order("created_at", { ascending: false });

    if (!roles || roles.length === 0) {
      document.getElementById("profileRoles").innerHTML =
        '<p style="text-align:center; opacity:0.5;">Nenhum rol√™ salvo ainda</p>';
      return;
    }

    const html = roles.map(r => `
      <div class="role-card">
        <h3>${r.titulo}</h3>
        <div class="date">${new Date(r.created_at).toLocaleDateString('pt-BR')}</div>
        <div class="button-group">
          <button onclick="window.openLoadedRole('${r.id}')" class="btn-secondary">Abrir</button>
          <button onclick="window.compartilharRole('${r.id}')">Compartilhar</button>
        </div>
      </div>
    `).join("");

    document.getElementById("profileRoles").innerHTML = html;
  }

  window.openLoadedRole = async function(id) {
    try {
      showLoadingOverlay('Abrindo rol√™...');

      const { data: wps, error } = await supabaseClient
        .from("waypoints")
        .select("*")
        .eq("role_id", id)
        .order("ts", { ascending: true });

      if (error) {
        console.error('Erro ao carregar waypoints:', error);
        hideLoadingOverlay();
        return;
      }

      document.getElementById("profileModal").classList.remove("active");
      clearMap();
      loadRoleData(wps);
      window.currentOpenedRoleId = id;

      // Insert share button after rendering
      document.getElementById("tabUpload").insertAdjacentHTML("afterend", `
        <button id="shareCurrentRole" style="
          position:absolute; bottom:35px; right:20px;
          background:#333; border:1px solid #555; color:white;
          padding:10px 14px; border-radius:12px;">
          Compartilhar
        </button>
      `);
      document.getElementById("shareCurrentRole").addEventListener("click", () => {
        window.compartilharRole(id);
      });

      // hide loader shortly after render
      setTimeout(() => hideLoadingOverlay(), 300);
    } catch (e) {
      console.error('Erro em openLoadedRole:', e);
      hideLoadingOverlay();
    }
  };

  // Compartilhar
  document.getElementById("shareRoute").addEventListener("click", () => {
    const id = window.lastSavedRoleId || window.currentOpenedRoleId;
    if (id) window.compartilharRole(id);
  });

  window.compartilharRole = function(id) {
  const shareURL = `${location.origin}${location.pathname}?role=${id}`;
  navigator.clipboard.writeText(shareURL).then(() => {
    showToast("üîó Link copiado!");
  });
};

// Universal share modal helper
function showUniversalShareModal(url, titulo) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position:fixed; inset:0; background:rgba(0,0,0,0.9);
    display:flex; justify-content:center; align-items:center;
    z-index:99999; color:white; padding:20px; text-align:center;
    backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
  `;

  modal.innerHTML = `
    <div style="max-width:400px; width:100%;">
      <h2 style="margin-bottom:16px;">Compartilhar Rol√™</h2>
      <p style="opacity:0.8; margin-bottom:16px;">${titulo}</p>

      <div style="
        background:#111; border:1px solid #333;
        padding:12px; border-radius:10px; margin-bottom:20px;
        font-size:12px; font-family:monospace; word-break:break-all;
      ">${url}</div>

      <button id="btnCopyLink" style="width:100%; padding:12px; background:#0066ff; color:white; border:none; border-radius:12px; margin-bottom:10px;">
        Copiar Link
      </button>

      <button id="btnOpenLink" style="width:100%; padding:12px; background:#333; color:white; border:none; border-radius:12px;">
        Abrir Link
      </button>

      <button id="closeShareModal" style="margin-top:20px; background:none; border:none; color:white; opacity:0.7; font-size:14px;">
        Fechar
      </button>
    </div>
  `;

  document.body.appendChild(modal);

  document.getElementById("btnCopyLink").addEventListener("click", () => {
    const temp = document.createElement("textarea");
    temp.value = url;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand("copy");
    temp.remove();
    alert("Link copiado!");
  });

  document.getElementById("btnOpenLink").addEventListener("click", () => {
    window.open(url, "_blank");
  });

  document.getElementById("closeShareModal").addEventListener("click", () => modal.remove());
  modal.addEventListener("click", e => { if (e.target === modal) modal.remove(); });
}

  // Helper functions
  function getBaseURL() {
    let base = window.location.origin + window.location.pathname;
    if (base.endsWith("index.html")) {
      base = base.replace("index.html", "");
    }
    base = base.replace(/\/+$/, "");
    return base;
  }
  async function fileToBase64(file) {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }


  async function compressImage(base64, maxWidth = 300) {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const scale = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.7));
      };
      img.src = base64;
    });
  }

  // Gest√£o de teclado virtual
  let keyboardOpen = false;
  ['focus', 'blur'].forEach(event => {
    document.addEventListener(event, e => {
      if (e.target.matches('input, textarea')) {
        keyboardOpen = event === 'focus';
        document.documentElement.classList.toggle('keyboard-open', keyboardOpen);
      }
    }, true);
  });

  // Prevent bounce scroll
  document.body.addEventListener('touchmove', e => {
    if (e.target.closest('#map')) return;
    if (!e.target.closest('.modal-fullscreen, #profileModal')) {
      e.preventDefault();
    }
  }, { passive: false });

  console.log('Rolezinho mobile-first loaded ‚úÖ');
}
</script>

</body>
</html>
