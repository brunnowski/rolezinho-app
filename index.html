<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Rolezinho">
<meta name="format-detection" content="telephone=no">
<link rel="mask-icon" href="icons/maskable-icon.png" color="#000000">
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
<title>Fotos no Mapa</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #000;
    color: white;
    overflow-x: hidden;
  }
  #map {
    height: calc(100vh - env(safe-area-inset-bottom) - 110px);
    width: 100%;
    border: none;
    margin: 0;
    padding: 0;
    touch-action: manipulation;
  }
  .mobile-btn {
    width: 90%;
    padding: 14px;
    font-size: 18px;
    border-radius: 12px;
    margin: 6px auto;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }
  #bottomBar button.mobile-btn {
    flex: 1;
    margin: 0 6px;
    height: 72px;
    font-size: 18px;
    padding: 0 10px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  @media (max-width: 600px) {
    #bottomBar button.mobile-btn {
      height: 64px;
      font-size: 16px;
    }
  }
  input, button { margin: 5px; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
  img.thumbnail { width: 100px; border-radius: 5px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }

  /* --- PATCH C.2.3-A — Touch + Modal + Z-index Fixes --- */
  .leaflet-popup {
    pointer-events: auto !important;
    z-index: 999999;
  }
  .leaflet-popup-content {
    pointer-events: auto !important;
  }
  .leaflet-popup-content button {
    pointer-events: auto !important;
    touch-action: manipulation !important;
  }
  .leaflet-container {
    touch-action: manipulation !important;
  }
  #profileModal {
    position: fixed;
    inset: 0;
    z-index: 1000000 !important;
    pointer-events: auto;
  }
  #profileModal, #profileModal * {
    pointer-events: auto !important;
  }
  body.no-scroll {
    overflow: hidden !important;
    height: 100vh !important;
  }
  .popup-media-wrapper {
    display: flex;
    justify-content: center;
    width: 100%;
  }
  .popup-media {
    max-width: 210px;
    border-radius: 12px;
  }

  html, body {
    overscroll-behavior: none !important;
    overscroll-behavior-y: none !important;
    touch-action: none;
  }

  #map {
    touch-action: pan-x pan-y !important;
  }

  #profileModal {
    overscroll-behavior: contain !important;
    -webkit-overflow-scrolling: touch !important;
  }
</style>
</head>
<body style="overscroll-behavior:none;">

<div id="onboarding" style="position:fixed; inset:0; background:black; color:white; z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:30px; text-align:center; padding:40px;">
  <div style="max-width:600px; width:90%; margin:0 auto; text-align:center; display:flex; flex-direction:column; align-items:center;">
    <h1 style="font-size:72px; margin-bottom:20px; width:90%; max-width:600px; text-align:center;">Bem-vindo ao App Rolezinho</h1>
    <p style="font-size:38.4px; max-width:600px; width:90%; text-align:center; line-height:1.4;">Crie mapas dos seus rolês a partir de suas fotos.</p>
    <button id="obNext1" style="padding:12px 24px; font-size:20px; border-radius:10px;">Começar</button>
    <button class="skipOnboarding" style="margin-top:10px;">Pular</button>
  </div>
</div>

<div id="onboarding2" style="display:none; position:fixed; inset:0; background:black; color:white; z-index:99999; overflow-y:auto; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:40px 20px; text-align:center; gap:40px;">
  <div style="max-width:600px; width:90%; margin:0 auto; text-align:center; display:flex; flex-direction:column; align-items:center;">
    <h2 style="font-size:72px; width:90%; max-width:600px; text-align:center; margin:0 auto;">Como funciona</h2>
    <p style="font-size:38.4px; width:90%; max-width:600px; text-align:center; line-height:1.6; margin:0 auto;">
      1 - Envie suas fotos<br>
      2 - O mapa do seu rolezinho é criado automaticamente<br>
      3 - Compartilhe o seu rolezinho com sua galera
    </p>
    <button id="obNext2" style="margin-top:50px; padding:14px 28px; font-size:24px; border-radius:12px;">Continuar</button>
    <button class="skipOnboarding" style="margin-top:10px;">Pular</button>
  </div>
</div>

<div id="onboarding3" style="display:none; position:fixed; inset:0; background:black; color:white; z-index:99999; overflow-y:auto; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px 20px; text-align:center; gap:20px; padding-bottom:60px;">
  <div style="max-width:600px; width:90%; margin:0 auto; text-align:center; display:flex; flex-direction:column; align-items:center;">
    <h2 style="font-size:48px; width:90%; max-width:600px; text-align:center;">Crie seu Perfil</h2>
    <p style="margin-top:10px; font-size:26.4px; width:90%; max-width:600px; text-align:center; line-height:1.4;">Digite seu nome e username:</p>
    <input id="onName" placeholder="Seu nome" style="margin-top:10px; padding:12px; width:90%; max-width:500px; border-radius:10px; font-size:18px;">
    <input id="onUser" placeholder="@username" style="margin-top:10px; padding:12px; width:90%; max-width:500px; border-radius:10px; font-size:18px;">
    <input id="onPhone" placeholder="Telefone" style="margin-top:10px; padding:12px; width:90%; max-width:500px; border-radius:10px; font-size:18px;">
    <input id="onEmail" placeholder="Email" style="margin-top:10px; padding:12px; width:90%; max-width:500px; border-radius:10px; font-size:18px;">
    <button id="finishOnboarding" style="margin-top:20px; padding:14px 20px; font-size:20px; border-radius:10px; width:90%; max-width:300px; align-self:center; margin-bottom:20px;">Concluir</button>
    <button class="skipOnboarding" style="margin-top:10px;">Pular</button>
  </div>
</div>

<div id="profileModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); color:white; z-index:1000000; padding:40px 20px; overflow-y:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;">
  <h2>Meu Perfil</h2>
  <p><b>Nome:</b> <span id="profileName"></span></p>
  <p><b>Username:</b> <span id="profileUser"></span></p>
  <p><b>Telefone:</b> <span id="profilePhone"></span></p>
  <p><b>Email:</b> <span id="profileEmail"></span></p>
  <div style="margin-top:20px;">
    <p><b>Foto de Perfil:</b></p>
    <img id="profilePhotoPreview" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; display:none; margin-bottom:10px;">
    <input type="file" id="profilePhotoInput" accept="image/*" style="padding:8px 12px; border-radius:6px;">
  </div>
  <h3>Meus Rolês</h3>
  <div id="profileRoles" style="margin-top:20px; max-height:60vh; overflow-y:auto; padding-right:10px;"></div>
  <button id="closeProfile" style="margin-top:20px; padding:8px 14px;">Fechar</button>
</div>

<!-- Reorder modal -->
<div id="reorderModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); color:white; z-index:1000001; padding:20px; overflow:auto;">
  <div style="max-width:720px; margin:0 auto;">
    <h2 style="text-align:center; margin-top:8px;">Ordenar seu Rolê</h2>
    <p style="text-align:center; opacity:0.85;">Arraste as miniaturas para reordenar. A ordem padrão é cronológica.</p>
    <div id="reorderList" style="max-width:640px; margin:18px auto; display:flex; flex-direction:column; gap:12px;"></div>
    <div style="display:flex; justify-content:center; gap:12px; margin-top:20px;">
      <button id="reorderConfirm" style="padding:12px 18px; border-radius:10px;">Confirmar ordem</button>
      <button id="reorderCancel" style="padding:12px 18px; border-radius:10px; background:#333;">Cancelar</button>
    </div>
  </div>
</div>

<input 
  type="file" 
  id="upload" 
  multiple 
  accept="image/*,video/*"
  capture="environment"
  style="opacity:0; position:absolute; inset:0; width:100%; height:100%; z-index:-1;"
>
<div id="bottomBar" style="position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #000;
  padding: 12px 0;
  display: none;
  justify-content: space-between;
  align-items: center;
  z-index: 99990;
  border-top: 1px solid #333;
  height: 110px;
  padding-bottom: env(safe-area-inset-bottom);">
  <button id="uploadBtn" class="mobile-btn" style="background:#111; border:2px solid #333; position:relative; overflow:hidden;">
    <input 
      type="file" 
      id="uploadOverlay"
      accept="image/*,video/*"
      capture="environment"
      style="position:absolute; inset:0; opacity:0; z-index:5;"
    >
    <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><path d="M12 2l4 4h-3v6h-2V6H8l4-4zm-7 14v4h14v-4h2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4h2z"/></svg>
    Mídias
  </button>

  <button id="saveRoute" class="mobile-btn" style="background:#111; border:2px solid #333; opacity:0.4; pointer-events:none; display:none;">
    Salvar
  </button>

  <button id="openProfile" class="mobile-btn" style="background:#111; border:2px solid #333;">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/></svg>
    Perfil
  </button>

  <button id="shareOpenedRole" class="mobile-btn" style="background:#0066ff; border:2px solid #0044cc; display:none;">
    Compartilhar
  </button>
</div>
<script>
function attachOnboardingListeners() {
  if (window._onboardingListenersAttached) return;
  window._onboardingListenersAttached = true;
  const ob1 = document.getElementById("onboarding");
  const ob2 = document.getElementById("onboarding2");
  const ob3 = document.getElementById("onboarding3");
  // Next buttons
  document.getElementById("obNext1").addEventListener("click", () => {
    ob1.style.display = "none";
    ob2.style.display = "block";
  });
  document.getElementById("obNext2").addEventListener("click", () => {
    ob2.style.display = "none";
    ob3.style.display = "block";
  });
  // Finish onboarding with validation
  document.getElementById("finishOnboarding").addEventListener("click", () => {
    const name = document.getElementById("onName").value.trim();
    const user = document.getElementById("onUser").value.trim();
    const phone = document.getElementById("onPhone").value.trim();
    const email = document.getElementById("onEmail").value.trim();
    if (!name || !user) { alert("Preencha nome e username."); return; }
    // Extra strict validation
    if (!/^\S+@\S+\.\S+$/.test(email)) { alert("Email inválido."); return; }
    if (!/^[0-9+\-\s]{6,}$/.test(phone)) { alert("Telefone inválido."); return; }
    localStorage.setItem("profileName", name);
    localStorage.setItem("profileUser", user);
    localStorage.setItem("profilePhone", phone);
    localStorage.setItem("profileEmail", email);
    document.getElementById("bottomBar").style.display = "flex";
    ob3.style.display = "none";
    document.getElementById("bottomBar").style.display = "flex";
    localStorage.setItem("onboardingDone", "1");
  });
  // Skip buttons
  document.querySelectorAll("#onboarding .skipOnboarding, #onboarding2 .skipOnboarding, #onboarding3 .skipOnboarding").forEach(btn => {
    btn.addEventListener("click", () => {
      ob1.style.display = "none";
      ob2.style.display = "none";
      ob3.style.display = "none";
      document.getElementById("bottomBar").style.display = "flex";
      localStorage.setItem("onboardingDone", "1");
    });
  });
}
// Utility: disable/enable map interactions when native picker is open
function disableMapInteraction() {
  try {
    if (map && map.dragging) map.dragging.disable();
    if (map && map.scrollWheelZoom) map.scrollWheelZoom.disable();
    if (map && map.touchZoom) map.touchZoom.disable();
    if (map && map.doubleClickZoom) map.doubleClickZoom.disable();
    if (map && map.boxZoom) map.boxZoom.disable();
  } catch(e){ /* map may not be ready yet */ }
}
function enableMapInteraction() {
  try {
    if (map && map.dragging) map.dragging.enable();
    if (map && map.scrollWheelZoom) map.scrollWheelZoom.enable();
    if (map && map.touchZoom) map.touchZoom.enable();
    if (map && map.doubleClickZoom) map.doubleClickZoom.enable();
    if (map && map.boxZoom) map.boxZoom.enable();
  } catch(e){ }
}

let _pickerOpenFlag = false;
function preOpenPicker() {
  _pickerOpenFlag = true;
  document.body.classList.add('no-scroll');
  disableMapInteraction();
  // Add a temporary fullscreen invisible overlay to absorb touch events (prevents ghost clicks)
  if (!document.getElementById('pickerOverlay')) {
    const ov = document.createElement('div');
    ov.id = 'pickerOverlay';
    ov.style.position = 'fixed';
    ov.style.inset = '0';
    ov.style.zIndex = '1000001';
    ov.style.background = 'transparent';
    document.body.appendChild(ov);
  }
}
function postClosePicker() {
  _pickerOpenFlag = false;
  document.body.classList.remove('no-scroll');
  enableMapInteraction();
  const ov = document.getElementById('pickerOverlay');
  if (ov) ov.remove();
}

// Hook upload UI: open native picker and manage iOS quirks
const uploadBtnEl = document.getElementById('uploadBtn');
const uploadOverlayEl = document.getElementById('uploadOverlay');
const uploadEl = document.getElementById('upload');

uploadBtnEl.addEventListener('click', (ev) => {
  // On some iOS versions synthetic click may be blocked; pre-enable protections then trigger click
  preOpenPicker();
  // small delay to ensure no-scroll applied before native picker opens
  setTimeout(() => { uploadEl.click(); }, 50);
});

uploadOverlayEl.addEventListener('click', (ev) => { preOpenPicker(); });
uploadOverlayEl.addEventListener('change', (e) => {
  // propagate files to main upload input and trigger change handler
  uploadEl.files = e.target.files;
  uploadEl.dispatchEvent(new Event('change'));
  // close picker protections
  setTimeout(postClosePicker, 150);
});

// Main input change handler will run the upload flow; ensure picker protections are cleared afterwards
uploadEl.addEventListener('change', (e) => {
  // Delay slightly to let any UI transitions finish
  setTimeout(() => {
    postClosePicker();
  }, 200);
});

// If user cancels the native picker, Safari may not fire change — listen to focus events to detect picker close
window.addEventListener('focus', () => {
  if (_pickerOpenFlag) {
    // small delay to allow browser internal focus handling
    setTimeout(() => {
      if (_pickerOpenFlag) postClosePicker();
    }, 300);
  }
});

// iOS Safari picker opening fix (keep for compatibility fallback)
uploadEl.addEventListener('click', () => {
  setTimeout(() => {}, 150);
});
</script>
<div id="map"></div>

<!-- Thumbnails container for sortable thumbnails -->
<div id="sortableThumbnails" style="display:flex; gap:10px; overflow-x:auto; padding:10px;"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>

let processedMedia = [];
let orderedMedia = [];
let ignoredMedia = [];
// --- IMAGE COMPRESSION FUNCTION ---
async function compressImage(dataUrl, maxSize = 300) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      resolve(canvas.toDataURL("image/jpeg", 0.7));
    };
    img.src = dataUrl;
  });
}

document.addEventListener("DOMContentLoaded", () => {
  // --- AUTOLOAD DE ROLÊ VIA LINK COMPARTILHADO ---
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has("role")) {
    try {
      const decoded = JSON.parse(LZString.decompressFromEncodedURIComponent(urlParams.get("role")));

      // Show shared meta box if available
      const metaBox = document.getElementById("sharedMeta");
      if (decoded.creator) {
        metaBox.innerHTML =
          `<b>Criado por:</b> ${decoded.creator}<br>` +
          `<b>Data:</b> ${new Date(decoded.data).toLocaleString()}<br>` +
          `<b>Pontos no rolê:</b> ${decoded.totalPoints}`;
        metaBox.style.display = "block";
      }

      // limpar caminho atual
      waypoints = decoded.waypoints || [];
      markers = [];

      map.eachLayer(layer => {
        if (layer instanceof L.Marker || layer instanceof L.Polyline) map.removeLayer(layer);
      });

      const bounds = [];

      waypoints.forEach((wp, i) => {
        const marker = L.marker([wp.lat, wp.lon]).addTo(map);
        markers.push(marker);

        // Use unified popup-media-wrapper and popup-media class for both image and video
        const mediaHTML = wp.isVideo
          ? `<div class="popup-media-wrapper"><video src="${wp.thumbnail}" class="popup-media" autoplay loop muted playsinline></video></div>`
          : `<div class="popup-media-wrapper"><img src="${wp.thumbnail}" class="popup-media" /></div>`;

        marker.bindPopup(`
        <div style="text-align:center;">
          <b>${wp.name}</b><br>
          ${mediaHTML}<br>
          <button class="popup-nav-btn" onclick="event.stopPropagation(); focusMarker(${i - 1})" style="margin-right:10px; padding:18px 26px; font-size:24px; border-radius:12px;">⬅️</button>
          <button class="popup-nav-btn" onclick="event.stopPropagation(); focusMarker(${i + 1})" style="padding:18px 26px; font-size:24px; border-radius:12px;">➡️</button>
        </div>`);

        marker.on("popupopen", () => {
          map.setView(marker.getLatLng(), map.getZoom(), { animate: true });
        });

        bounds.push([wp.lat, wp.lon]);
      });

      if (bounds.length > 0) {
        map.flyToBounds(bounds, { padding: [50,50], animate: true, duration: 0.7 });
      }

      if (window.currentRoute) { map.removeLayer(window.currentRoute); window.currentRoute = null; }
      let tempCoordsShared = null;
      if (waypoints.length > 1) tempCoordsShared = waypoints.map(w => [w.lat, w.lon]);
      map.once("moveend", () => {
        if (tempCoordsShared) {
          window.currentRoute = L.polyline(tempCoordsShared, {
            color: 'blue',
            weight: 3,
            fill: false,
            fillOpacity: 0,
            bubblingMouseEvents: false
          }).addTo(map);
        }
      });

      console.log("Rolê compartilhado carregado com sucesso.");
    } catch (e) {
      console.error("Erro carregando rolê compartilhado:", e);
    }
  }
  // --- FIM DO AUTOLOAD ---
  // localStorage onboardingDone try/catch
  try { localStorage.getItem("onboardingDone"); } catch(e) { localStorage.clear(); }
  const ob1 = document.getElementById("onboarding");
  const ob2 = document.getElementById("onboarding2");
  const ob3 = document.getElementById("onboarding3");

  if (!localStorage.getItem("onboardingDone")) {
    ob1.style.display = "flex";
    ob2.style.display = "none";
    ob3.style.display = "none";
  } else {
    ob1.style.display = "none";
    ob2.style.display = "none";
    ob3.style.display = "none";
  }
  // Defensive onboarding reset before listeners
  try {
    const t = localStorage.getItem("onboardingDone");
    if (t !== null && t !== "1") throw new Error("Corrupted onboarding flag");
  } catch(e) {
    localStorage.removeItem("onboardingDone");
  }
  attachOnboardingListeners();
  document.getElementById("bottomBar").style.display = localStorage.getItem("onboardingDone") ? "flex" : "none";
});

function loadRole(id) {
  window.currentOpenedRoleId = id;
  document.getElementById("shareOpenedRole").style.display = "inline-block";
  const saved = JSON.parse(localStorage.getItem("rolesSalvos") || "[]");
  const role = saved.find(r => r.id === id);
  if (!role) return;

  // Clear map markers and route
  map.eachLayer(layer => {
    if (layer instanceof L.Marker || layer instanceof L.Polyline) map.removeLayer(layer);
  });

  waypoints = role.waypoints;
  markers = [];

  const bounds = [];

  waypoints.forEach((wp, i) => {
    const marker = L.marker([wp.lat, wp.lon]).addTo(map);
    markers.push(marker);

    // Use unified popup-media-wrapper and popup-media class for both image and video
    const mediaHTML = wp.isVideo
      ? `<div class="popup-media-wrapper"><video src="${wp.thumbnail}" class="popup-media" autoplay loop muted playsinline></video></div>`
      : `<div class="popup-media-wrapper"><img src="${wp.thumbnail}" class="popup-media" /></div>`;

    marker.bindPopup(`
      <div style="text-align:center;">
        <b>${wp.name}</b><br>
        ${mediaHTML}<br>
        <button class="popup-nav-btn" onclick="event.stopPropagation(); focusMarker(${i - 1})" style="margin-right:10px; padding:18px 26px; font-size:24px; border-radius:12px;">⬅️</button>
        <button class="popup-nav-btn" onclick="event.stopPropagation(); focusMarker(${i + 1})" style="padding:18px 26px; font-size:24px; border-radius:12px;">➡️</button>
      </div>
    `);
    marker.on("popupopen", () => {
      map.setView(marker.getLatLng(), map.getZoom(), { animate: true });
    });
    marker.on("click", () => {
      map.setView(marker.getLatLng(), map.getZoom(), { animate: true });
    });

    bounds.push([wp.lat, wp.lon]);
  });

  if (bounds.length > 0) {
    map.flyToBounds(bounds, { padding: [50,50], animate: true, duration: 0.7 });
  }

  if (window.currentRoute) { map.removeLayer(window.currentRoute); window.currentRoute = null; }
  let tempCoordsLoad = null;
  if (waypoints.length > 1) tempCoordsLoad = waypoints.map(wp => [wp.lat, wp.lon]);
  map.once("moveend", () => {
    if (tempCoordsLoad) {
      window.currentRoute = L.polyline(tempCoordsLoad, {
        color: 'blue',
        weight: 3,
        fill: false,
        fillOpacity: 0,
        bubblingMouseEvents: false
      }).addTo(map);
    }
  });
}

const map = L.map('map').setView([0,0], 2);

L.tileLayer('https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
  attribution: '© CARTO © OpenStreetMap',
  detectRetina: false
}).addTo(map);

let waypoints = [];
let markers = [];

function focusMarker(index) {
  if (!markers.length) return;
  const total = markers.length;
  const i = ((index % total) + total) % total;
  const m = markers[i];
  const pos = m.getLatLng();
  map.setView(pos, 16, { animate: true });
  map.once('moveend', () => {
    try { m.openPopup(); } catch(e){}
  });
  setTimeout(() => {
    try { m.openPopup(); } catch(e){}
  }, 350);
}

// (handled above with 150ms setTimeout for iOS Safari picker opening fix)
document.getElementById('upload').addEventListener('change', async (e) => {
  waypoints = [];
  processedMedia = [];
  orderedMedia = [];
  const files = e.target.files;
  if (!files || files.length === 0) {
    alert("Nenhuma mídia selecionada. Tente novamente.");
    return;
  }
  const bounds = [];

  // Limpar mapa
  map.eachLayer(layer => {
    if (layer instanceof L.Marker) map.removeLayer(layer);
  });

  const saveBtn = document.getElementById("saveRoute");
  saveBtn.style.display = "inline-block";
  saveBtn.disabled = false;
  saveBtn.style.opacity = "1";
  saveBtn.style.pointerEvents = "auto";

  for (let file of files) {
    // Ignorar vídeos maiores que 4 segundos
    if (file.type.startsWith("video")) {
      const videoURL = URL.createObjectURL(file);
      const video = document.createElement("video");
      video.src = videoURL;

      // Aguarda carregar metadata
      await new Promise(res => {
        video.onloadedmetadata = () => res();
      });

      if (video.duration > 4) {
        console.warn("Vídeo com mais de 4s — usando primeiros 4s:", file.name);
      }
    }

    // Extrair GPS (funciona para fotos, Live Photos e vídeos .mov do iPhone)
    let exif = null;

    // 1 — Tentativa EXIF padrão
    try {
      exif = await window.exifr.gps(file);
    } catch (e) {
      exif = null;
    }

    // 2 — Tentativa EXIF completa
    if (!exif || !exif.latitude) {
      try {
        const full = await window.exifr.parse(file);

        if (full) {
          // Padrões comuns
          if (full.GPSLatitude && full.GPSLongitude) {
            exif = { latitude: full.GPSLatitude, longitude: full.GPSLongitude };
          }

          // QuickTime ISO6709
          if (!exif || !exif.latitude) {
            const iso = full["com.apple.quicktime.location.ISO6709"] ||
                        full["Location.ISO6709"] ||
                        full["GPSCoordinates"];

            if (iso && typeof iso === "string") {
              // Ex: "+37.33182-122.03118+096.000/"
              const m = iso.match(/([-+][0-9.]+)([-+][0-9.]+)/);
              if (m) {
                exif = { latitude: parseFloat(m[1]), longitude: parseFloat(m[2]) };
              }
            }
          }
        }
      } catch(e) {
        console.warn("EXIF (full) fallback failed.");
      }
    }

    // 3 — Último fallback: sem GPS
    if (!exif || !exif.latitude) {
      exif = { latitude: null, longitude: null };
    }
    // --- D.1 FINAL — Fallback por timestamp: copiar GPS da foto mais próxima ---
    if (exif.latitude === null || exif.longitude === null) {
      let bestMatch = null;
      let bestDiff = Infinity;

      // tentar achar outro arquivo com GPS válido e timestamp próximo
      waypoints.forEach(other => {
        if (!other.ts) return;
        if (!other.lat || !other.lon) return;

        const diff = Math.abs(new Date(other.ts).getTime() - new Date(file.lastModified).getTime());
        if (diff < bestDiff) {
          bestDiff = diff;
          bestMatch = other;
        }
      });

      // se achou alguém do mesmo minuto, copiar suas coordenadas
      if (bestMatch && bestDiff <= 60000) {
        exif.latitude = bestMatch.lat;
        exif.longitude = bestMatch.lon;
      }
    }

    // --- Custom GPS filter block inserted here ---
    // After fallback D.1 GPS extraction
    if (!exif || !exif.latitude || !exif.longitude) {
      ignoredMedia.push(file.name);
      console.warn("Arquivo sem GPS ignorado:", file.name);
      continue;
    }

    // --- D.2-B — Strict GPS filter (after D.1 fallback) ---
    if (!exif || exif.latitude === null || exif.longitude === null) {
      console.warn("Mídia ignorada por falta de GPS:", file.name);
      ignoredMedia.push({ name: file.name, type: file.type, ts: file.lastModified });
      alert("Atenção: a mídia '" + file.name + "' foi ignorada por falta de localização.");
      continue; // skip this file entirely
    }

    if (exif?.latitude && exif?.longitude) {
      // Determine if GPS is interpolated
      const isInterpolated = (exif.latitude === null || exif.longitude === null) ? true : false;
      // Compress thumbnail before storing
      let rawURL = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => {
          if (!reader.result || reader.result.length < 50) {
            console.warn("FileReader empty — retrying fallback read");
            alert("Atenção: uma das mídias está corrompida e foi ignorada.");
            const reader2 = new FileReader();
            reader2.onload = () => resolve(reader2.result);
            reader2.readAsDataURL(file);
            return;
          }
          resolve(reader.result);
        };
        reader.readAsDataURL(file);
      });
      const url = await compressImage(rawURL); // compress thumbnail

      waypoints.push({
        lat: exif.latitude,
        lon: exif.longitude,
        name: file.name,
        thumbnail: url,
        isVideo: file.type.startsWith("video"),
        isInterpolated: isInterpolated
      });
      // Store compressed thumbnail for double safety
      waypoints[waypoints.length - 1].thumbnailCompressed = url;

      const ts = exif?.DateTimeOriginal || file.lastModified || Date.now();
      waypoints[waypoints.length - 1].ts = new Date(ts);

      const index = waypoints.length - 1;
      const marker = L.marker([exif.latitude, exif.longitude]).addTo(map);
      markers[index] = marker;

      let mediaHTML = file.type.startsWith("video")
        ? `<div class="popup-media-wrapper"><video src="${url}" class="popup-media" autoplay loop muted playsinline></video></div>`
        : `<div class="popup-media-wrapper"><img src="${url}" class="popup-media" /></div>`;

      const isInterpolatedVal = isInterpolated;
      const mediaItem = {
        lat: exif.latitude,
        lon: exif.longitude,
        name: file.name,
        preview: url,
        url: url,
        type: file.type.startsWith("video") ? "video" : "image",
        isInterpolated: isInterpolated,
        ts: new Date(ts)
      };
      processedMedia.push(mediaItem);
      orderedMedia.push(mediaItem);

      const popupHTML = `
  <div style="text-align:center; max-width:220px;">
    <b>${file.name}</b><br>
    ${mediaHTML}<br>
    <div style="display:flex; justify-content:center; gap:10px; margin-top:8px;">
      <button class="popup-nav-btn" onclick="event.stopPropagation(); focusMarker(${index - 1});"
        aria-label="Anterior" style="padding:10px 14px; font-size:18px; border-radius:10px;">
        ⬅️
      </button>
      <button class="popup-nav-btn" onclick="event.stopPropagation(); focusMarker(${index + 1});"
        aria-label="Próximo" style="padding:10px 14px; font-size:18px; border-radius:10px;">
        ➡️
      </button>
    </div>
    ${isInterpolatedVal ? '<div style="font-size:11px; opacity:0.6; margin-top:8px;">GPS estimado</div>' : ''}
  </div>
`;

      marker.bindPopup(popupHTML);
      marker.on("popupopen", () => {
        map.setView(marker.getLatLng(), map.getZoom(), { animate: true });
      });
      marker.on("click", () => {
        map.setView(marker.getLatLng(), map.getZoom(), { animate: true });
      });

      bounds.push([exif.latitude, exif.longitude]);
    }
  }

  // Render sortable thumbnails after upload
  const sortableThumbnails = document.getElementById("sortableThumbnails");
  sortableThumbnails.innerHTML = "";
  orderedMedia.forEach((item, index) => {
    const thumb = document.createElement("img");
    thumb.src = item.preview;
    thumb.style.width = "70px";
    thumb.style.height = "70px";
    thumb.style.borderRadius = "10px";
    thumb.style.objectFit = "cover";
    thumb.setAttribute("data-index", index);
    thumb.setAttribute("draggable", "true");
    sortableThumbnails.appendChild(thumb);
  });
  enableSorting();

  // Open reorder modal to allow user to adjust order before rendering route
  openReorderModal(waypoints, bounds);
});
function renderWaypointsAndRoute(waypointsToRender, boundsArray) {
  // clear previous markers
  markers = [];
  map.eachLayer(layer => {
    if (layer instanceof L.Marker || layer instanceof L.Polyline) map.removeLayer(layer);
  });

  const newBounds = [];
  // Use orderedMedia instead of processedMedia
  let items = orderedMedia.length > 0 ? orderedMedia : waypointsToRender;
  let i = 0;
  for (let item of items) {
    const marker = L.marker([item.lat, item.lon]).addTo(map);
    markers.push(marker);

    let mediaHTML = item.type === "video"
      ? `<div class="popup-media-wrapper"><video src="${item.url}" class="popup-media" autoplay loop muted playsinline></video></div>`
      : `<div class="popup-media-wrapper"><img src="${item.url}" class="popup-media" /></div>`;

    const popupHTML = `
      <div style="text-align:center; max-width:260px;">
        <b>${item.name}</b><br>
        ${mediaHTML}<br>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:8px;">
          <button class="popup-nav-btn" onclick="event.stopPropagation(); focusMarker(${i - 1});"
            aria-label="Anterior" style="padding:10px 14px; font-size:18px; border-radius:10px;">
            ⬅️
          </button>
          <button class="popup-nav-btn" onclick="event.stopPropagation(); focusMarker(${i + 1});"
            aria-label="Próximo" style="padding:10px 14px; font-size:18px; border-radius:10px;">
            ➡️
          </button>
        </div>
      </div>
    `;

    marker.bindPopup(popupHTML);
    marker.on("popupopen", () => {
      map.setView(marker.getLatLng(), map.getZoom(), { animate: true });
    });
    marker.on("click", () => {
      map.setView(marker.getLatLng(), map.getZoom(), { animate: true });
    });

    newBounds.push([item.lat, item.lon]);
    i++;
  }

  // draw route after user-centered flyToBounds finishes
  if (window.currentRoute) { map.removeLayer(window.currentRoute); window.currentRoute = null; }
  let tempRouteCoords = null;
  if (items.length > 1) tempRouteCoords = items.map(wp => [wp.lat, wp.lon]);

  map.once("moveend", () => {
    if (tempRouteCoords) {
      window.currentRoute = L.polyline(tempRouteCoords, {
        color: "blue",
        weight: 3,
        fill: false,
        fillOpacity: 0,
        bubblingMouseEvents: false
      }).addTo(map);
    }
  });

  if (newBounds.length > 0) {
    map.flyToBounds(newBounds, { padding: [50,50], animate: true, duration: 0.7 });
  }
}
// SortableJS-like drag-and-drop for thumbnails
function enableSorting() {
  const sortableThumbnails = document.getElementById("sortableThumbnails");
  let dragged;

  sortableThumbnails.addEventListener("dragstart", (e) => {
    dragged = e.target;
    e.target.style.opacity = .5;
  });

  sortableThumbnails.addEventListener("dragend", (e) => {
    e.target.style.opacity = "";
  });

  sortableThumbnails.addEventListener("dragover", (e) => {
    e.preventDefault();
  });

  sortableThumbnails.addEventListener("drop", (e) => {
    e.preventDefault();
    if (e.target.tagName === "IMG" && dragged !== e.target) {
      const children = [...sortableThumbnails.children];
      const draggedIndex = children.indexOf(dragged);
      const targetIndex = children.indexOf(e.target);
      if (draggedIndex > targetIndex) {
        sortableThumbnails.insertBefore(dragged, e.target);
      } else {
        sortableThumbnails.insertBefore(dragged, e.target.nextSibling);
      }
      updateOrderFromDOM();
    }
  });
}

function updateOrderFromDOM() {
  const sortableThumbnails = document.getElementById("sortableThumbnails");
  const images = [...sortableThumbnails.children];
  orderedMedia = images.map(img => {
    const idx = parseInt(img.getAttribute("data-index"));
    return processedMedia[idx];
  });
}


function openReorderModal(initialWaypoints, initialBounds) {
  const modal = document.getElementById('reorderModal');
  const list = document.getElementById('reorderList');
  list.innerHTML = '';

  // create items
  initialWaypoints.forEach((wp, idx) => {
    const item = document.createElement('div');
    item.className = 'reorder-item';
    item.draggable = true;
    item.dataset.wpIndex = idx;
    item.style.display = 'flex';
    item.style.alignItems = 'center';
    item.style.background = '#0b0b0b';
    item.style.border = '1px solid #222';
    item.style.padding = '8px';
    item.style.borderRadius = '10px';
    item.style.gap = '12px';

    const thumb = document.createElement(wp.isVideo ? 'video' : 'img');
    thumb.className = 'thumbnail';
    thumb.style.width = '96px';
    thumb.style.height = '96px';
    thumb.style.objectFit = 'cover';
    if (wp.isVideo) { thumb.src = wp.thumbnail; thumb.autoplay = true; thumb.loop = true; thumb.muted = true; thumb.playsInline = true; }
    else { thumb.src = wp.thumbnail; }

    const meta = document.createElement('div');
    meta.style.flex = '1';
    meta.innerHTML = `<div style="font-size:14px">${wp.name}</div><div style="font-size:12px; opacity:0.7">${wp.ts ? new Date(wp.ts).toLocaleString() : ''}</div>`;

    item.appendChild(thumb);
    item.appendChild(meta);

    // drag events
    item.addEventListener('dragstart', (ev) => { ev.dataTransfer.setData('text/plain', ev.target.dataset.wpIndex); ev.dataTransfer.effectAllowed = 'move'; });
    item.addEventListener('dragover', (ev) => { ev.preventDefault(); ev.dataTransfer.dropEffect = 'move'; });
    item.addEventListener('drop', (ev) => {
      ev.preventDefault();
      const fromIndex = parseInt(ev.dataTransfer.getData('text/plain'));
      const toIndex = parseInt(ev.target.closest('.reorder-item') ? ev.target.closest('.reorder-item').dataset.wpIndex : ev.target.dataset.wpIndex);
      if (isNaN(toIndex)) return;
      // reorder DOM
      const fromNode = list.querySelector(`[data-wp-index='${fromIndex}']`);
      const toNode = list.querySelector(`[data-wp-index='${toIndex}']`);
      if (fromNode && toNode) {
        if (fromIndex < toIndex) toNode.after(fromNode);
        else toNode.before(fromNode);
        // reassign dataset indices to match DOM order
        Array.from(list.children).forEach((ch, i) => ch.dataset.wpIndex = i);
      }
    });

    list.appendChild(item);
  });

  // show modal
  modal.style.display = 'block';

  // attach buttons
  document.getElementById('reorderConfirm').onclick = () => {
    // build new order
    const newOrder = Array.from(list.children).map(ch => initialWaypoints[parseInt(ch.dataset.wpIndex)]);
    modal.style.display = 'none';
    // update global waypoints and render
    waypoints = newOrder;
    renderWaypointsAndRoute(waypoints, initialBounds);
  };
  document.getElementById('reorderCancel').onclick = () => {
    modal.style.display = 'none';
    // proceed with original order
    renderWaypointsAndRoute(initialWaypoints, initialBounds);
  };
}

// Salvar rota no localStorage
document.getElementById('saveRoute').addEventListener('click', () => {
  try {
    console.log("DEBUG: saveRoute clicked. Waypoints:", waypoints);
    if (!waypoints || !waypoints.length) {
      alert("Nenhum rolê para salvar.");
      return;
    }

    const title = prompt("Dê um título ao seu rolê:");
    if (!title) {
      alert("Título obrigatório.");
      return;
    }

    const saved = JSON.parse(localStorage.getItem("rolesSalvos") || "[]");

    const role = {
      id: Date.now(),
      titulo: title,
      data: new Date().toISOString(),
      waypoints: waypoints.map(wp => ({
        lat: wp.lat ?? null,
        lon: wp.lon ?? null,
        name: wp.name || "",
        thumbnail: wp.thumbnailCompressed || wp.thumbnail || null,
        isVideo: !!wp.isVideo,
        ts: wp.ts || null
      }))
    };

    console.log("DEBUG: Saving role:", role);
    saved.push(role);
    localStorage.setItem("rolesSalvos", JSON.stringify(saved));
    console.log("DEBUG: rolesSalvos now:", JSON.parse(localStorage.getItem("rolesSalvos")));

    alert("Rolê salvo com sucesso!");

    // disable button until new media uploaded
    const saveBtn = document.getElementById("saveRoute");
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.style.opacity = "0.4";
      saveBtn.style.pointerEvents = "none";
    }

    // refresh profile list if modal open
    try { renderProfileRoles(); } catch(e) { console.warn('renderProfileRoles missing', e); }
  } catch (err) {
    console.error('Erro ao salvar rolê:', err);
    alert('Erro ao salvar rolê. Veja o console para mais detalhes.');
  }
});


// --- STORY EDITOR TYPE SHARE AURA ---
document.addEventListener("DOMContentLoaded", () => {
  const storyEditor = document.getElementById("storyEditor");
  const storyCanvas = document.getElementById("storyCanvas");

  if (!storyCanvas) {
    console.error("storyCanvas not found — story editor not initialized.");
    return;
  }

  const ctx = storyCanvas.getContext("2d");

  document.getElementById("closeStoryEditor").addEventListener("click", () => {
    storyEditor.style.display = "none";
  });

  document.getElementById("exportStory").addEventListener("click", () => {
    storyCanvas.toBlob(blob => saveAs(blob, "role-story.jpg"));
  });
});

function renderProfileRoles() {
  const saved = JSON.parse(localStorage.getItem("rolesSalvos") || "[]");
  document.getElementById("profileRoles").innerHTML = saved.map(r => `
    <div style="padding:12px; background:#111; border:1px solid #555; border-radius:10px; margin:10px 0; color:white;">
      <b>${r.titulo || ("Rolê " + r.id)}</b><br>
      <span style="font-size:14px; opacity:0.8;">${new Date(r.data).toLocaleString()}</span><br>

      <button onclick="document.getElementById('profileModal').style.display='none'; loadRole(${r.id});"
        style="margin-top:10px; padding:6px 10px; border-radius:6px; background:#333; color:white; border:1px solid:#666;">
        Abrir
      </button>

      <button onclick="editarRole(${r.id})"
        style="margin-top:10px; margin-left:10px; padding:6px 10px; border-radius:6px; background:#222; color:white; border:1px solid:#555;">
        Editar
      </button>

      <button onclick="compartilharRole(${r.id})"
        style="margin-top:10px; margin-left:10px; padding:6px 10px; border-radius:6px; background:#0066ff; color:white; border:1px solid:#0044cc;">
        Compartilhar
      </button>
    </div>
  `).join("");
}

console.log("Profile button found:", document.getElementById("openProfile"));
document.getElementById("openProfile").addEventListener("click", () => {
  console.log("Opening profile modal");
  const m = document.getElementById("profileModal");
  document.getElementById("profileName").textContent = localStorage.getItem("profileName") || "—";
  document.getElementById("profileUser").textContent = localStorage.getItem("profileUser") || "—";
  document.getElementById("profilePhone").textContent = localStorage.getItem("profilePhone") || "—";
  document.getElementById("profileEmail").textContent = localStorage.getItem("profileEmail") || "—";
  const photo = localStorage.getItem("profilePhoto");
  const pp = document.getElementById("profilePhotoPreview");
  if (photo) { pp.src = photo; pp.style.display = "block"; } else { pp.style.display = "none"; }
  renderProfileRoles();
  m.style.display = "block";
  m.style.zIndex = "999999";
  // prevent page scroll and map interaction while profile is open
  document.body.classList.add("no-scroll");
  try { disableMapInteraction(); } catch(e) { /* ignore if map not ready */ }

  // prevent touches from bubbling to the map underneath (stops ghost clicks)
  m.addEventListener('touchstart', function _stopTouch(e){ e.stopPropagation(); }, { passive: false });
  m.addEventListener('click', function _stopClick(e){ e.stopPropagation(); });
});

document.getElementById("shareOpenedRole").addEventListener("click", () => {
  if (window.currentOpenedRoleId) {
    compartilharRole(window.currentOpenedRoleId);
  }
});

document.getElementById("closeProfile").addEventListener("click", () => {
  document.getElementById("profileModal").style.display = "none";
  document.body.classList.remove("no-scroll");
  try { enableMapInteraction(); } catch(e) { }
  // remove any leftover picker overlay that might block touches
  const pov = document.getElementById('pickerOverlay'); if (pov) pov.remove();
});

// Safety: prevent touch/click events from reaching the map when any modal is open
['profileModal','reorderModal','reorderModal','onboarding','onboarding2','onboarding3','storyEditor'].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('touchstart', (e) => { if (el.style.display !== 'none') e.stopPropagation(); }, { passive: false });
  el.addEventListener('click', (e) => { if (el.style.display !== 'none') e.stopPropagation(); });
});

function compartilharRole(id) {
  const saved = JSON.parse(localStorage.getItem("rolesSalvos") || "[]");
  const role = saved.find(r => r.id === id);
  if (!role) return;

  const payload = {
    titulo: role.titulo,
    waypoints: role.waypoints,
    creator: localStorage.getItem("profileUser") || "Usuário",
    data: role.data,
    totalPoints: role.waypoints.length
  };

  const encoded = LZString.compressToEncodedURIComponent(JSON.stringify(payload));
  const shareURL = window.location.origin + window.location.pathname + "?role=" + encoded;

  navigator.clipboard.writeText(shareURL).then(() => {
    alert("Link do rolê copiado!");
  });
}

function editarRole(id) {
  const saved = JSON.parse(localStorage.getItem("rolesSalvos") || "[]");
  const roleIndex = saved.findIndex(r => r.id === id);
  if (roleIndex === -1) {
    alert("Rolê não encontrado.");
    return;
  }

  const novoTitulo = prompt("Editar título do rolê:", saved[roleIndex].titulo || "");
  if (!novoTitulo) return;

  saved[roleIndex].titulo = novoTitulo;
  localStorage.setItem("rolesSalvos", JSON.stringify(saved));

  try { renderProfileRoles(); } catch(e) {}
  alert("Título atualizado!");
}
// Foto de perfil
document.getElementById("profilePhotoInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (!file.type.startsWith("image/")) { alert("Envie apenas imagens para foto de perfil."); return; }
  const reader = new FileReader();
  reader.onload = () => {
    if (!reader.result) return;
    localStorage.setItem("profilePhoto", reader.result);
    const pp = document.getElementById("profilePhotoPreview");
    pp.src = reader.result;
    pp.style.display = "block";
  };
  reader.readAsDataURL(file);
});
// Make sure all popup-nav-btns always stop propagation
document.addEventListener("click", (e) => {
  if (e.target.classList && e.target.classList.contains("popup-nav-btn")) {
    e.stopPropagation();
  }
});
</script>

<div id="storyEditor" style="display:none; position:fixed; inset:0; background:black; z-index:9999; padding:20px;">
  <button id="closeStoryEditor" style="position:absolute; top:20px; right:20px; z-index:10000; padding:8px 14px;">Fechar</button>
  <div id="storyCanvasWrapper" style="width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
    <canvas id="storyCanvas" width="1080" height="1920" style="background:black; border:2px solid #444;"></canvas>
  </div>
  <button id="exportStory" style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); padding:10px 18px;">Exportar Story</button>
</div>
<div id="sharedMeta" style="display:none; width:100%; padding:20px; background:#000; color:white; text-align:center; font-size:18px; line-height:1.5;"></div>
</body>
</html>
