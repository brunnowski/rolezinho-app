<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rolezinho App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <style>
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden;
            background: #f4f8fb;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        #app-content {
            height: calc(100dvh - 65px);
            padding-bottom: 65px;
            box-sizing: border-box;
        }
        .bottom-menu {
            position: fixed;
            z-index: 900;
            left: 0; right: 0; bottom: 0;
            height: 70px;
            background: #ffffff;
            box-shadow: 0 -4px 25px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top-left-radius: 28px;
            border-top-right-radius: 28px;
        }
        .bottom-menu button {
            background: none;
            border: none;
            flex: 1 1 0;
            font-size: 13px;
            padding: 6px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #9aa0a6;
            transition: color 0.2s;
        }
        .bottom-menu button.active {
            color: #ff6600;
        }
        .bottom-menu i {
            font-size: 22px;
        }
        /* MAP PAGE */
        #map {
            height: calc(100dvh - 65px);
            width: 100vw;
            position: relative;
            z-index: 1;
        }
        /* Thumbnail carousel - mobile first */
        #thumb-carousel {
            position: fixed;
            left: 50%; transform: translateX(-50%);
            bottom: 150px;
            max-width: 600px;
            width: 90%;
            height: 86px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            box-sizing: border-box;
            z-index: 1002;
            pointer-events: none;
        }
        .thumbs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 6px 0;
            flex: 1 1 auto;
            scroll-snap-type: x mandatory;
            pointer-events: auto;
        }
        .thumbs::-webkit-scrollbar{ height:8px }
        .thumb {
            flex: 0 0 auto;
            width: 56px;
            height: 56px;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            scroll-snap-align: center;
            position: relative;
            border: 2px solid transparent;
        }
        .thumb img{ width:100%; height:100%; object-fit:cover; display:block }
        .thumb.active{ border-color:#2196F3 }
        .thumb .index-badge{
            position:absolute; right:6px; top:6px; background:rgba(0,0,0,0.45); color:#fff; font-size:11px; padding:3px 6px; border-radius:10px
        }
        .thumb-nav{
            background: rgba(255,255,255,0.95);
            border: none;
            width: 30px; height:30px; border-radius:18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 18px; line-height:0; display:flex; align-items:center; justify-content:center;
            pointer-events: auto;
        }
        .floating-btn {
            position: fixed;
            bottom: 95px;
            right: 24px;
            z-index: 1001;
            background: #ff6600;
            color: #fff;
            border: none;
            border-radius: 50%;
            box-shadow: 0 3px 12px rgba(255,102,0,0.45);
            width: 60px;
            height: 60px;
            font-size: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .floating-btn input[type="file"] {
            display: none;
        }
        /* Auth modal */
#auth-modal { display:none; position:fixed; left:0; top:0; right:0; bottom:0; z-index:2000; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); }
#auth-modal .modal-inner { width:92%; max-width:420px; background:#fff; padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
#auth-modal input[type="email"], #auth-modal input[type="password"]{ width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ddd; box-sizing:border-box }
#auth-modal .auth-actions{ display:flex; gap:8px; margin-top:12px }
#auth-modal button{ flex:1; padding:10px; border-radius:8px; border:none }
        /* Simple Home/Profile styling */
        .simple-page {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 2em;
            color: #444;
        }
        .feed-card {
            background:#fff; border-radius:16px; padding:14px;
            box-shadow:0 2px 10px rgba(0,0,0,0.06);
        }
        .feed-user-row { display:flex; align-items:center; gap:12px; }
        .feed-avatar { width:42px; height:42px; border-radius:50%; object-fit:cover; }
        .feed-username { font-weight:600; font-size:15px; }
        .feed-time { font-size:12px; color:#777; }
        .feed-map-img { width:100%; height:170px; object-fit:cover; border-radius:12px; margin-top:12px; }
        .feed-title { font-size:16px; margin-top:10px; font-weight:600; }
        .feed-metrics { display:flex; justify-content:space-between; margin-top:12px; }
        .feed-metric-box { text-align:center; }
        .feed-metric-label { font-size:12px; color:#777; }
        .feed-metric-value { font-size:15px; font-weight:600; }
        .feed-actions { display:flex; justify-content:space-between; margin-top:12px; }
        .feed-actions button {
            border:none; background:none; font-size:14px;
            color:#555; display:flex; align-items:center; gap:6px;
        }
        .route-list {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .route-card {
            display: flex;
            background: #fff;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            cursor: pointer;
        }

        .route-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 12px;
        }

        .route-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .route-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .route-date {
            font-size: 13px;
            color: #666;
        }

        .route-title-input {
            font-size: 16px;
            font-weight: 600;
            border: none;
            background: transparent;
            margin-bottom: 6px;
            padding: 0;
            width: 100%;
        }

        .route-title-input:focus {
            outline: none;
            border-bottom: 1px solid #1e88e5;
        }

        .route-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .route-actions button {
            padding: 6px 10px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #e9eef3;
        }

        .route-open-btn {
            background: #1e88e5;
            color: #fff;
        }

        .route-share-btn {
            background: #43a047;
            color: #fff;
        }
        @media (max-width:600px) {
            .floating-btn { right: 12px; bottom: 78px;}
            .bottom-menu { height: 58px; }
            #map { height: calc(100dvh - 58px); }
        }

/* Ensure popup close button stays clickable above UI overlays */
.leaflet-popup {
    z-index: 5000 !important;
}
.leaflet-popup-content-wrapper,
.leaflet-popup-tip {
    z-index: 5001 !important;
}
.leaflet-popup-close-button {
    z-index: 6000 !important;
}
    </style>
</head>
<body>
    <div id="app-content">
        <div id="home-page" class="simple-page">
          <div id="feed-container"
               style="padding:16px; display:flex; flex-direction:column; gap:18px;">
          </div>
        </div>
        <div id="map-page" style="display:none; height:100%">
            <div id="map"></div>
            <!-- THUMBNAIL CAROUSEL (mobile-first) -->
            <div id="thumb-carousel" style="display:none" aria-hidden="false">
                <button id="thumb-prev" class="thumb-nav" aria-label="Anterior">‚Äπ</button>
                <div id="thumbs" class="thumbs" role="list"></div>
                <button id="thumb-next" class="thumb-nav" aria-label="Pr√≥ximo">‚Ä∫</button>
            </div>
            <button id="add-photos-btn" class="floating-btn" title="Adicionar Fotos">
                <i class="fa fa-camera"></i>
                <input type="file" accept="image/*,video/*" multiple id="photo-upload-input">
            </button>
        </div>
        <div id="profile-page" style="display:none; padding:16px; overflow-y:auto;"></div>
    </div>
    <!-- SAVE ROUTE BUTTON (shows after route plotted) -->
<div id="save-rol√™-container" 
     style="position:fixed; left:50%; transform:translateX(-50%);
            bottom:240px; z-index:1003; display:none;
            flex-direction:row; align-items:flex-start; gap:14px;
            width:90%; max-width:600px;">
  
  <!-- Pencil Button (small) -->
  <button id="edit-route-btn" style="flex:0 0 58px; height:58px; border-radius:16px; border:none; background:#ffffff; box-shadow:0 6px 18px rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:center;">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 20h9"/>
      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
    </svg>
  </button>

  <!-- Main Title+Desc + Save Wrapped Together -->
  <div style="flex:1; display:flex; flex-direction:column; gap:16px;">
      
      <div id="route-meta-inline" 
           style="width:100%; max-width:600px; margin:0 auto;
                  display:flex; flex-direction:column;
                  gap:14px; padding:18px;
                  background:#ffffff; border-radius:18px;
                  box-shadow:0 6px 20px rgba(0,0,0,0.12);">
        <input id="route-inline-title" type="text"
            placeholder="D√™ um nome ao seu Rol√™ (Ex: Sunset na Paulista)"
            style="width:100%; padding:16px 16px; border-radius:14px; border:1px solid #cfd5dc; font-size:17px; font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.05);">

        <textarea id="route-inline-desc"
            placeholder="Conte um pouco sobre a experi√™ncia e dicas."
            style="width:100%; height:120px; padding:16px 16px; border-radius:14px; border:1px solid #cfd5dc; font-size:16px; resize:none; line-height:1.45; box-shadow:0 2px 5px rgba(0,0,0,0.05);"></textarea>
      </div>

      <button id="save-route-btn"
        style="width:100%; max-width:600px; margin:0 auto;
               padding:18px 24px; border-radius:18px; border:none;
               background:#1e88e5; color:#fff; font-size:18px; font-weight:600;
               box-shadow:0 10px 26px rgba(30,136,229,0.25);
               display:flex; align-items:center; justify-content:center; gap:10px;"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
        Salvar
      </button>

  </div>

</div>
    <nav class="bottom-menu">
        <button id="nav-home" class="active"><i class="fa fa-home"></i><span>Home</span></button>
        <button id="nav-map"><i class="fa fa-map"></i><span>Map</span></button>
        <button id="nav-profile"><i class="fa fa-user"></i><span>Profile</span></button>
    </nav>
    <!-- AUTH MODAL -->
<div id="auth-modal">
  <div class="modal-inner">
    <h3 style="margin-top:0">Entrar ou Criar Conta</h3>
    <input id="auth-email" type="email" placeholder="Seu email" />
    <input id="auth-pass" type="password" placeholder="Sua senha" />
    <p style="font-size:13px; color:#555; margin-top:6px;">
      Ao criar uma conta, voc√™ concorda com os
      <a href="https://app.kortex.co/public/document/0e51d08e-1574-4b7a-be8a-ca39fb346a9c" target="_blank" style="color:#1e88e5; text-decoration:underline;">
        Termos de Uso
      </a>.
    </p>
    <div class="auth-actions">
      <button id="auth-login-btn" style="background:#1e88e5; color:#fff;">Login</button>
      <button id="auth-signup-btn" style="background:#43a047; color:#fff;">Criar conta</button>
    </div>
  </div>
</div>
    <!-- LIBS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- EXIF Reader (tiny) -->
    <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/full.umd.js"></script>
    <!-- Supabase JS client via ES module -->
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const SUPABASE_URL = "https://qjanxtpcszdinwxdrmpc.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYW54dHBjc3pkaW53eGRybXBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTI2NzUsImV4cCI6MjA3OTE4ODY3NX0.AZUMTReBfk1IR32RCGGZiuR-NpsxzBRkeWItTFCR444";

      window.supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
    <script>
    async function waitForSupabase(){
      return new Promise(resolve=>{
        const check = setInterval(()=>{
          if(window.supa && window.supa.auth){
            clearInterval(check);
            resolve(window.supa);
          }
        },50);
      });
    }
    window.waitForSupabase = waitForSupabase;
    </script>
    <script>
      // Global helper required by all modules
      function getSupa() {
        return window.supa;
      }
    </script>
    <script>
        // Ensure global access to Supabase
        // Tab switching logic
        function showPage(page) {
            // Display pages
            document.getElementById('home-page').style.display = (page === 'home') ? '' : 'none';
            document.getElementById('map-page').style.display = (page === 'map') ? '' : 'none';
            document.getElementById('profile-page').style.display = (page === 'profile') ? '' : 'none';

            // Fix active state on bottom menu
            document.getElementById('nav-home').classList.remove('active');
            document.getElementById('nav-map').classList.remove('active');
            document.getElementById('nav-profile').classList.remove('active');

            if (page === 'home') document.getElementById('nav-home').classList.add('active');
            if (page === 'map') document.getElementById('nav-map').classList.add('active');
            if (page === 'profile') document.getElementById('nav-profile').classList.add('active');

            // Re-render map if switching to map
            if (page === 'map' && typeof renderMap === 'function') {
                setTimeout(renderMap, 150);
            }
        }

        document.getElementById('nav-home').onclick = async () => {
            const user = await getCurrentUser();

            if (user) {
                // Logged-in ‚Üí show feed
                showPage('home');
                loadHomeFeed();
                return;
            }

            // Not logged in ‚Üí show static home screen with logo + message
            showPage('home');
            document.getElementById('feed-container').innerHTML = `
                <div style="text-align:center; padding:40px;">
                    <img src="logo.png" style="width:140px; opacity:0.95; margin-bottom:20px;">
                    <p style="font-size:18px; color:#444; margin-top:10px;">
                        Entre para ver os rol√™s da comunidade.
                    </p>
                </div>
            `;
        };

        document.getElementById('nav-map').onclick = () => {
            showPage('map');
        };

        document.getElementById('nav-profile').onclick = async () => {
            const user = await getCurrentUser();

            if (!user) {
                showPage('profile');
                document.getElementById('profile-page').innerHTML =
                    '<div style="padding:20px; font-size:18px;">Fa√ßa login para ver suas rotas.</div>';
                return;
            }

            showPage('profile');
            await loadUserRoutes();
        };

        // ---- MAP & PHOTOS -----
        // Modal open/close helpers for route meta modal
        function openRouteMetaModal(){}
        function closeRouteMetaModal(){}
        // Auto‚Äërestore the map when redirected with ?auth=1
        document.addEventListener('DOMContentLoaded', async ()=>{
          await window.waitForSupabase();
          const user = await getCurrentUser();

          if (user) {
              showPage('map');
              loadHomeFeed();
          } else {
              showPage('map');
              document.getElementById('feed-container').innerHTML = `
                  <div style="text-align:center; padding:40px;">
                      <img src="logo.png" style="width:140px; opacity:0.95; margin-bottom:20px;">
                      <p style="font-size:18px; color:#444; margin-top:10px;">
                          Entre para ver os rol√™s da comunidade.
                      </p>
                  </div>
              `;
          }

          // Route meta modal logic (originally inside DOMContentLoaded)
          const routeMetaModal = document.getElementById('route-meta-modal');
          const metaTitleInput = document.getElementById('route-meta-title');
          const metaDescInput = document.getElementById('route-meta-desc');
          const metaCancelBtn = document.getElementById('route-meta-cancel');
          const metaSaveBtn = document.getElementById('route-meta-save');

          if (metaCancelBtn) metaCancelBtn.onclick = closeRouteMetaModal;
          if (metaSaveBtn) metaSaveBtn.onclick = async () => {
              const title = metaTitleInput.value.trim();
              const description = metaDescInput.value.trim();
              const lastRouteId = window._lastSavedRouteId;

              if (!lastRouteId) {
                  closeRouteMetaModal();
                  return;
              }

              const { error } = await getSupa()
                  .from('routes')
                  .update({ title, description })
                  .eq('route_id', lastRouteId);

              if (error) {
                  console.error(error);
                  alert("Erro ao salvar t√≠tulo/descri√ß√£o.");
              }

              closeRouteMetaModal();
          }

          const params = new URLSearchParams(window.location.search);
          if(params.has('auth')){
              showPage('map');
              await afterAuthAutoSave();
              try { history.replaceState({}, '', window.location.pathname); } catch(e){}
          }
          const openParam = params.get('open');
          if (openParam) {
              showPage('map');
              loadSavedRoute(openParam);
              try { history.replaceState({}, '', window.location.pathname); } catch(e){}
              return;
          }
        });
        let map, routeLayer, markersLayer, waypoints = [];
        let markers = []; // store L.marker references
let currentThumbIndex = 0;

// ===== Supabase (window.supa is set by ES module above) =====

// pending save state: store the last exifArr the user attempted to save
let pendingSave = null;

        function renderMap() {
            if (!map) {
                map = L.map('map', { center:[-23.5505, -46.6333], zoom:13, gestureHandling: true });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);
                markersLayer = L.layerGroup().addTo(map);
                routeLayer = L.layerGroup().addTo(map);
            }
            setTimeout(()=>{ map.invalidateSize(); }, 80);
        }

        // --- FLOATING BUTTON -- 
        const addPhotosBtn = document.getElementById('add-photos-btn');
        const photoInput = document.getElementById('photo-upload-input');

        addPhotosBtn.onclick = () => { photoInput.click(); };
        addPhotosBtn.addEventListener('touchend', e=>{
            e.preventDefault(); photoInput.click();
        });

        photoInput.addEventListener('change', async function(e){
            if (!photoInput.files.length) return;
            // parse all images/videos
            let allExif = [];
            for (const file of photoInput.files) {
                const isVideo = file.type.startsWith("video/");
                try {
                    const exif = await exifr.parse(file, { gps: true, tiff: true });
                    if (exif && exif.latitude && exif.longitude) {
                        allExif.push({
                            file,
                            lat: exif.latitude,
                            lng: exif.longitude,
                            date: exif.DateTimeOriginal || exif.CreateDate || file.lastModified,
                            name: file.name,
                            isVideo: isVideo
                        });
                    } else {
                        alert(`A m√≠dia "${file.name}" n√£o possui metadados de localiza√ß√£o e ser√° ignorada.`);
                    }
                } catch(e) {
                    alert(`A m√≠dia "${file.name}" n√£o possui metadados de localiza√ß√£o e ser√° ignorada.`);
                }
            }
            if (allExif.length < 1) {
                alert('Nenhuma m√≠dia v√°lida com localiza√ß√£o foi encontrada.');
                return;
            }

            // sort oldest to newest
            allExif.sort((a,b)=>{
                return new Date(a.date) - new Date(b.date);
            });
            waypoints = allExif.map(ex=>({lat: ex.lat, lng: ex.lng}));
            plotWaypointsAndRoute(allExif);
        });

        async function plotWaypointsAndRoute(exifArr) {
            document.getElementById('thumb-carousel').style.display = 'none';
            setSaveButtonVisible(false);
            if (!map) renderMap();
            routeLayer.clearLayers();
            markersLayer.clearLayers();
            editingRoute = false;
disableThumbnailReorder();
            // clear old markers and revoke object urls
            markers.forEach(m=>{ if(m._thumbUrl){ URL.revokeObjectURL(m._thumbUrl); } });
            markers = [];
            setSaveButtonVisible(false);
editingRoute = false;
disableThumbnailReorder();
            // Place markers and collect marker objects
            exifArr.forEach((ex, idx)=>{
                const isStart = idx === 0;
                const isEnd = idx === exifArr.length - 1;
                const icon = isStart
                    ? L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize: [36,36], className: 'start-marker' })
                    : isEnd
                        ? L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize: [36,36], className: 'end-marker' })
                        : undefined;
                const marker = L.marker([ex.lat, ex.lng], icon ? { icon } : undefined)
                    .bindPopup(`
                        <div style="min-width:180px">
                          <label style="font-size:13px;color:#555">T√≠tulo:</label>
                          <input type="text" class="popup-title-input" value="${ex.name}" 
                                 style="width:100%;padding:6px;margin:6px 0;border:1px solid #ccc;border-radius:6px;">
                          <label style="font-size:13px;color:#555">Descri√ß√£o:</label>
                          <textarea class="popup-desc-input" 
                                    style="width:100%;height:60px;padding:6px;border:1px solid #ccc;border-radius:6px;resize:none;"></textarea>
                          <button class="popup-save-btn" 
                                  style="margin-top:8px;width:100%;padding:8px;background:#1e88e5;color:#fff;border:none;border-radius:6px;">
                            Salvar
                          </button>
                        </div>
                    `);
                marker.addTo(markersLayer);
                marker._exif = ex; // attach original file/meta
                markers.push(marker);

                // when marker clicked open the corresponding thumbnail (centered)
                marker.on('click', ()=>{
                    const i = markers.indexOf(marker);
                    if(i>=0) openThumbnailAt(i);
                });
            });

            // Attach popup save event
            map.on('popupopen', (e) => {
                const popupEl = e.popup._contentNode;
                const marker = e.popup._source;
                const titleInput = popupEl.querySelector('.popup-title-input');
                const descInput = popupEl.querySelector('.popup-desc-input');
                const saveBtn = popupEl.querySelector('.popup-save-btn');
                if (saveBtn) {
                    saveBtn.onclick = () => {
                        marker._exif.name = titleInput.value.trim();
                        marker._exif.description = descInput.value.trim();
                        alert('Informa√ß√µes atualizadas!');
                    };
                }
            });

            // If only one media, skip OSRM routing entirely
            if (exifArr.length === 1) {
                // Center map on the single marker
                const single = exifArr[0];
                if (markers[0]) {
                    map.setView([single.lat, single.lng], 16);
                    markers[0].openPopup();
                }
                // Render thumbnails normally
                renderThumbnails(exifArr);
                currentThumbIndex = 0;
                openThumbnailAt(0);
                return; // do NOT try to build a route
            }
            // Build OSRM Route request (same as before)
            const coordsStr = exifArr.map(ex=>`${ex.lng},${ex.lat}`).join(';');
            const url = `https://router.project-osrm.org/route/v1/foot/${coordsStr}?overview=full&geometries=geojson`;
            try {
                const resp = await fetch(url);
                const data = await resp.json();
                if (data.code === 'Ok' && data.routes.length) {
                    const route = data.routes[0].geometry;
                    const poly = L.geoJSON(route, {color: '#0099ff', weight:5, opacity:0.75}).addTo(routeLayer);
                    map.fitBounds(poly.getBounds(), { padding: [60,60] });
                } else {
                    alert('N√£o foi poss√≠vel tra√ßar a rota.');
                }
            } catch(e) {
                alert('Erro ao conectar ao servi√ßo de rotas: ' + e.message);
            }

            // Render thumbnails and enable navigation
            renderThumbnails(exifArr);
            // open first thumbnail by default (center popup)
            currentThumbIndex = 0;
            openThumbnailAt(0);
        }

        // Render thumbnails into the carousel and wire click handlers
        function renderThumbnails(exifArr){
            document.getElementById('thumb-carousel').style.display = 'flex';
            setSaveButtonVisible(true);
            const thumbs = document.getElementById('thumbs');
            thumbs.innerHTML = '';
            exifArr.forEach((ex, idx)=>{
                const url = URL.createObjectURL(ex.file);
                const el = document.createElement('div');
                el.className = 'thumb';
                el.dataset.index = idx;
                el.innerHTML = `<img src="${url}" alt="thumb-${idx}" /><div class="index-badge">${idx+1}</div>`;
                el.addEventListener('click', ()=>{ openThumbnailAt(idx); });
                thumbs.appendChild(el);
                // store thumb url on marker so we can revoke later
                if(markers[idx]) markers[idx]._thumbUrl = url;
            });

            // wire prev/next buttons
            const prev = document.getElementById('thumb-prev');
            const next = document.getElementById('thumb-next');
            prev.onclick = ()=>{ navigateThumb(-1); };
            next.onclick = ()=>{ navigateThumb(1); };

            // make sure carousel is scrollable to active
            setTimeout(()=>{ scrollThumbIntoView(currentThumbIndex); }, 60);
        }

// --- Thumbnail drag reorder support ---

function openSavedRoutePoint(idx){
    if (!markers[idx]) return;
    const marker = markers[idx];
    // Pan & open popup
    map.panTo(marker.getLatLng(), { animate:true });
    marker.openPopup();
    // Force Leaflet to refresh popup contents async
    setTimeout(() => {
      if (marker.getPopup()) {
        marker.update();
      }
    }, 50);
}

async function loadSavedRoute(routeId) {
  setSaveButtonVisible(false);
  if (!map) renderMap();
  routeLayer.clearLayers();
  markersLayer.clearLayers();
  markers = [];

  const { data, error } = await getSupa()
    .from('routes')
    .select('*')
    .eq('route_id', routeId)
    .single();

  if (error || !data) {
    alert('Erro ao carregar o rol√™.');
    return;
  }

  const exifArr = data.points
    .sort((a, b) => a.order - b.order)
    .map(p => ({
      lat: p.lat,
      lng: p.lng,
      name: 'Ponto',
      file: null
    }));

  exifArr.forEach((ex, idx) => {
    const marker = L.marker([ex.lat, ex.lng]).addTo(markersLayer);
    marker._exif = ex;
    markers.push(marker);

    const photoMatch = data.photos?.find(p => p.order === idx);

    const popupHtml = `
      <div style="min-width:200px; text-align:center;">
        <img src="${photoMatch?.url || ''}"
             style="width:100%; height:140px; object-fit:cover; border-radius:8px; margin-bottom:8px;" />

        <div style="font-size:15px; font-weight:600; margin-bottom:6px;">
          Ponto ${idx + 1} de ${exifArr.length}
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:10px;">
          <button class="popup-prev" data-idx="${idx}"
                  style="padding:6px 10px; border:none; border-radius:6px; background:#eee;">‚óÄ</button>
          <button class="popup-next" data-idx="${idx}"
                  style="padding:6px 10px; border:none; border-radius:6px; background:#eee;">‚ñ∂</button>
        </div>
      </div>
    `;
    marker.bindPopup(popupHtml);
  });

  map.on('popupopen', (e) => {
    const popup = e.popup._contentNode;
    const marker = e.popup._source;
    const idx = markers.indexOf(marker);

    if (!popup) return;

    const imgEl = popup.querySelector('img');
    if (imgEl) {
      const match = data.photos?.find(p => p.order === idx);
      imgEl.src = match?.url || '';
    }

    const prevBtn = popup.querySelector('.popup-prev');
    const nextBtn = popup.querySelector('.popup-next');

    if (prevBtn) {
      prevBtn.onclick = (ev) => {
        ev.stopPropagation();
        const targetIdx = (idx - 1 + markers.length) % markers.length;
        openSavedRoutePoint(targetIdx);
      };
    }

    if (nextBtn) {
      nextBtn.onclick = (ev) => {
        ev.stopPropagation();
        const targetIdx = (idx + 1) % markers.length;
        openSavedRoutePoint(targetIdx);
      };
    }

    // Ensure arrow navigation always triggers correct popup refresh
    popup.addEventListener("click", (ev)=>{
      ev.stopPropagation();
    });
  });

  if (data.photos?.length) {
    const first = data.photos[0].url;
    const preload = new Image();
    preload.src = first;
  }

  const coords = exifArr.map(p => [p.lat, p.lng]);
  const bounds = L.latLngBounds(coords);
  map.fitBounds(bounds, { padding: [60, 60] });

  document.getElementById('thumb-carousel').style.display = 'none';
}
let editingRoute = false;

function enableThumbnailReorder(){
  const thumbs = document.getElementById('thumbs').children;
  [...thumbs].forEach(el=>{
    el.setAttribute('draggable','true');
    el.ondragstart = ev=>{ ev.dataTransfer.setData('idx', el.dataset.index); };
    el.ondragover = ev=> ev.preventDefault();
    el.ondrop = ev=>{
      ev.preventDefault();
      const from = Number(ev.dataTransfer.getData('idx'));
      const to = Number(el.dataset.index);
      if(from===to) return;
      const parent = document.getElementById('thumbs');
      const nodes = [...parent.children];
      const moved = nodes[from];
      parent.removeChild(moved);
      parent.insertBefore(moved, nodes[to]);
      const newOrder = [...parent.children].map(n=> markers[Number(n.dataset.index)]._exif);
      markers = markers.sort((a,b)=> newOrder.indexOf(a._exif) - newOrder.indexOf(b._exif));
    };
  });
}

function disableThumbnailReorder(){
  const thumbs = document.getElementById('thumbs').children;
  [...thumbs].forEach(el=>{
    el.removeAttribute('draggable');
    el.ondragstart = null;
    el.ondragover = null;
    el.ondrop = null;
  });
}

        function navigateThumb(delta){
            if(!markers.length) return;
            currentThumbIndex = (currentThumbIndex + delta + markers.length) % markers.length; // loop
            openThumbnailAt(currentThumbIndex);
        }

        function openThumbnailAt(idx){
            if(idx < 0 || idx >= markers.length) return;
            currentThumbIndex = idx;
            // highlight thumb
            const thumbs = document.querySelectorAll('.thumb');
            thumbs.forEach(t=> t.classList.toggle('active', Number(t.dataset.index)===idx));
            // scroll into view center
            scrollThumbIntoView(idx);
            // center map so popup shows centered on screen
            const marker = markers[idx];
            if(marker){
                const latlng = marker.getLatLng();
                // compute container center and move marker there so popup is centered
                const mapSize = map.getSize();
                const containerCenter = L.point(mapSize.x/2, mapSize.y/2 - 40); // slight upward offset
                const markerPoint = map.latLngToContainerPoint(latlng);
                const delta = markerPoint.subtract(containerCenter);
                const targetPoint = map.containerPointToLatLng(markerPoint.subtract(delta));
                map.panTo(targetPoint, {animate:true});
                marker.openPopup();
            }
        }

        function scrollThumbIntoView(idx){
            const el = document.querySelector(`.thumb[data-index="${idx}"]`);
            if(el){
                el.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
            }
        }

// ===== AUTH & SAVE HELPERS =====
// Show or hide the Save button (show when thumbnails exist)
function setSaveButtonVisible(visible){
    const container = document.getElementById('save-rol√™-container');
    container.style.display = visible ? 'flex' : 'none';

    // Disable bottom nav buttons while editing or saving
    const homeBtn = document.getElementById('nav-home');
    const mapBtn = document.getElementById('nav-map');
    const profileBtn = document.getElementById('nav-profile');

    if (visible) {
        homeBtn.style.pointerEvents = "none";
        profileBtn.style.pointerEvents = "none";
        homeBtn.style.opacity = "0.35";
        profileBtn.style.opacity = "0.35";
    } else {
        homeBtn.style.pointerEvents = "";
        profileBtn.style.pointerEvents = "";
        homeBtn.style.opacity = "";
        profileBtn.style.opacity = "";
    }
}

// Check for logged-in user
async function getCurrentUser(){
    const { data, error } = await getSupa().auth.getUser();
    if(error) return null;
    return data?.user || null;
}

// Show a simple modal to login/signup (we'll add markup later)
function showAuthModal(){
    const m = document.getElementById('auth-modal');
    if(m) m.style.display = 'flex';
}
function hideAuthModal(){
    const m = document.getElementById('auth-modal');
    if(m) m.style.display = 'none';
}

// signup with email + password (simple flow)
async function handleSignup(email, password){
    let redirectBase = window.location.origin;
    if (redirectBase.startsWith("file")) {
        redirectBase = "https://brunnowski.github.io/rolezinho-app";
    }
    const { data, error } = await getSupa().auth.signUp({
        email,
        password,
        options: {
            emailRedirectTo: redirectBase + '?auth=1'
        }
    });
    return { data, error };
}

async function handleSignin(email, password){
    const { data, error } = await getSupa().auth.signInWithPassword({ email, password });
    return { data, error };
}

// Save route + images to Supabase Storage and insert a record into 'routes' table
async function saveRouteToSupabase(exifArr, options = {}){
    const user = await getCurrentUser();
    if(!user) {
        // trigger auth flow and set pending
        pendingSave = exifArr;
        showAuthModal();
        return;
    }

    const routeId = 'route_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
    // build points payload
    const points = exifArr.map((ex, i)=>({ lat: ex.lat, lng: ex.lng, order: i }));

    // Upload each photo to Supabase Storage
    const uploadedPhotos = [];
    for (let i=0;i<exifArr.length;i++){
        const file = exifArr[i].file;
        const filename = `${i}_${file.name}`;
        const path = `roles/${user.id}/${routeId}/${filename}`;
        try {
            const { data: uploadData, error: uploadError } = await getSupa().storage.from('roles').upload(path, file, { upsert: true });
            if(uploadError){
                console.error('Upload error', uploadError);
                continue;
            }
            const { data: publicUrlData } = getSupa().storage.from('roles').getPublicUrl(path);
            uploadedPhotos.push({ url: publicUrlData.publicUrl, order: i, filename });
        } catch(err){
            console.error('Upload exception', err);
        }
    }

    // Insert route record, now with title/description from inline fields if provided
    try{
        const { title = "", description = "" } = options;
        const { data: insertData, error: insertError } = await getSupa().from('routes').insert([{
            user_id: user.id,
            route_id: routeId,
            points: points,
            photos: uploadedPhotos,
            created_at: new Date().toISOString(),
            title,
            description
        }]);
        if(insertError){
            console.error('Insert error', insertError);
            alert('Erro ao salvar a rota. Veja o console para detalhes.');
            return;
        }
        alert('Rol√™ salvo com sucesso!');
        window._lastSavedRouteId = routeId;
        
        // Close popup only AFTER saving successfully
if (typeof map !== "undefined" && map.closePopup) {
    map.closePopup();
}
        // Instead of openRouteMetaModal(), update inline fields:
        document.getElementById('route-inline-title').value = title || "";
        document.getElementById('route-inline-desc').value = description || "";
        // hide Save UI
        setSaveButtonVisible(false);
        editingRoute = false;
        disableThumbnailReorder();
    } catch(e){
        console.error(e);
        alert('Erro inesperado ao salvar.');
    }
}

// After successful login/signup, if pendingSave exists, auto-save
async function afterAuthAutoSave(){
    const user = await getCurrentUser();
    if(user && pendingSave){
        const exifArr = pendingSave;
        pendingSave = null;
        hideAuthModal();
        await saveRouteToSupabase(exifArr);
    }
}

// Save button handler
document.getElementById('save-route-btn').addEventListener('click', async () => {
    console.log("üîµ SAVE CLICKED");
    console.log("Markers:", markers);

    const exifArr = markers.map(m => m._exif).filter(Boolean);

    console.log("EXIF ARRAY:", exifArr);

    if (!exifArr.length) {
        alert('Nenhuma rota dispon√≠vel ‚Äî nenhum ponto encontrado.');
        return;
    }

    // Get title/desc from inline fields before saving
    const inlineTitle = document.getElementById('route-inline-title').value.trim();
    const inlineDesc = document.getElementById('route-inline-desc').value.trim();

    // Require title and description before saving
    if (!inlineTitle || !inlineDesc) {
        alert("D√™ um nome ao rol√™ e escreva uma descri√ß√£o antes de salvar.");
        return;
    }

    const user = await getCurrentUser();
    console.log("USER:", user);

    if (user) {
        showPage('map');
        await saveRouteToSupabase(exifArr, { title: inlineTitle, description: inlineDesc });
        return;
    }

    pendingSave = exifArr;
    showAuthModal();
});

// EDIT ROUTE BUTTON HANDLER
const editBtn = document.getElementById('edit-route-btn');
editBtn.addEventListener('click', ()=>{
  editingRoute = !editingRoute;

  // Disable nav buttons when editing route
  const homeBtn = document.getElementById('nav-home');
  const profileBtn = document.getElementById('nav-profile');

  if (editingRoute) {
      homeBtn.style.pointerEvents = "none";
      profileBtn.style.pointerEvents = "none";
      homeBtn.style.opacity = "0.35";
      profileBtn.style.opacity = "0.35";
  } else {
      homeBtn.style.pointerEvents = "";
      profileBtn.style.pointerEvents = "";
      homeBtn.style.opacity = "";
      profileBtn.style.opacity = "";
  }

  if(editingRoute){
    enableThumbnailReorder();
    editBtn.style.background = '#ffe28a';
  } else {
    disableThumbnailReorder();
    editBtn.style.background = '#ffffff';
  }
});

// Auth modal controls (signup / login)
// EVENT DELEGATION for dynamic modal buttons
document.getElementById('auth-modal').addEventListener('click', async (ev)=>{
    await window.waitForSupabase();
    const el = ev.target;
    // Close modal when clicking outside modal-inner
    if (el.id === 'auth-modal') {
        hideAuthModal();
        return;
    }

    // LOGIN
    if (el.id === 'auth-login-btn') {
        const email = document.getElementById('auth-email')?.value;
        const pass = document.getElementById('auth-pass')?.value;
        if (!email || !pass) { alert('Preencha email e senha'); return; }

        const { error } = await handleSignin(email, pass);
        if (error) { alert('Erro no login: ' + error.message); return; }

        hideAuthModal();
        await afterAuthAutoSave();

        // If opening a shared route, skip map start
        const params = new URLSearchParams(window.location.search);
        if (params.has('open')) {
            showPage('map');
            return;
        }

        showPage('profile');
        await loadUserRoutes();
    }

    // SIGNUP
    if(el.id === 'auth-signup-btn'){
        const email = document.getElementById('auth-email')?.value;
        const pass = document.getElementById('auth-pass')?.value;
        if(!email || !pass){ alert('Preencha email e senha'); return; }
        const { error } = await handleSignup(email, pass);
        if(error){ alert('Erro no cadastro: ' + error.message); return; }

        showPage('profile');
        await loadUserRoutes();

        const inner = document.querySelector('#auth-modal .modal-inner');
        inner.innerHTML = `
            <h3 style="margin-top:0">Conta criada!</h3>
            <p style="font-size:15px;color:#444;margin-top:10px">
                Verifique seu email para confirmar sua conta e continuar salvando seu rol√™.
            </p>
            <button id="open-email-app" style="width:100%; padding:12px; margin-top:18px; border:none; border-radius:8px; background:#1e88e5; color:#fff; font-size:16px;">
                Abrir app de email
            </button>
            <p style="font-size:14px;color:#555;margin-top:16px">
                Ap√≥s confirmar, voc√™ retornar√° automaticamente √† sua √∫ltima rota.
            </p>
        `;

        setTimeout(()=>{
            const openBtn = document.getElementById('open-email-app');
            if(openBtn) openBtn.onclick = ()=>{
                let tried = false;

                // iOS Mail inbox (best for iPhone)
                tried = true;
                window.location.href = 'message://';

                // Gmail (Android) ‚Äì tries to open inbox instead of compose
                setTimeout(()=>{
                    if(tried){
                        window.location.href = 'googlegmail:///';
                    }
                }, 350);

                // Outlook (Android/iOS)
                setTimeout(()=>{
                    if(tried){
                        window.location.href = 'ms-outlook://';
                    }
                }, 700);

                // Fallback to 'mailto:' (opens app picker)
                setTimeout(()=>{
                    window.location.href = 'mailto:';
                }, 1100);
            };
        },50);
    }
});

// listen for auth state changes (email confirmation / login)
window.waitForSupabase().then(supaClient => 
  supaClient.auth.onAuthStateChange(async (event, session) => {
}));

// Show MAP by default on mobile PWAs if desired
        // showPage('map'); // Uncomment if you want to start at map

// --- Load user routes for profile page ---
async function loadUserRoutes() {
    const user = await getCurrentUser();
    if (!user) {
        document.getElementById('profile-page').innerHTML = `
            <div style="padding:20px; font-size:18px;">Fa√ßa login para ver suas rotas.</div>
        `;
        return;
    }

    const { data, error } = await getSupa()
        .from('routes')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

    if (error) {
        console.error(error);
        return;
    }

    if (!data.length) {
        document.getElementById('profile-page').innerHTML = `
            <div style="padding:20px; font-size:18px;">Voc√™ ainda n√£o salvou nenhum rol√™.</div>
        `;
        return;
    }

    const html = data.map(route => {
        const thumb = route.photos?.[0]?.url || "";
        return `
            <div class="route-card" data-route-id="${route.route_id}">
                <img class="route-thumb" src="${thumb}">
                <div class="route-info">
                    <input class="route-title-input" value="${route.title || ("Rol√™ " + route.route_id)}" />
                    <div class="route-date">${new Date(route.created_at).toLocaleString()}</div>
                    <div class="route-actions">
                        <button class="route-open-btn">Abrir</button>
                        <button class="route-share-btn">Compartilhar</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    const container = document.getElementById('profile-page');
    container.innerHTML = '';
    container.innerHTML = `<div class="route-list">${html}</div>`;
    // Attach actions for each route card
    document.querySelectorAll('.route-card').forEach(card => {
        const routeId = card.dataset.routeId;

        // OPEN BUTTON
        card.querySelector('.route-open-btn').onclick = (ev) => {
            ev.stopPropagation();
            showPage('map');
            loadSavedRoute(routeId);
        };

        // SHARE BUTTON
        card.querySelector('.route-share-btn').onclick = async () => {
            const shareUrl = `${window.location.href.split('?')[0]}?open=${routeId}`;
            try {
                await navigator.share({
                    title: "Meu rol√™",
                    text: "Veja meu rol√™ no mapa!",
                    url: shareUrl
                });
            } catch (e) {
                navigator.clipboard.writeText(shareUrl);
                alert("Link copiado!");
            }
        };

        // TITLE INPUT (auto-save on blur)
        const titleInput = card.querySelector('.route-title-input');
        titleInput.addEventListener('blur', async () => {
            const newTitle = titleInput.value.trim();
            const { error } = await getSupa()
                .from('routes')
                .update({ title: newTitle })
                .eq('route_id', routeId);

            if (error) {
                console.error(error);
                alert("Erro ao salvar t√≠tulo.");
            }
        });
    });
}
    </script>
</div>

</body>
</html>
    <script>
Ôªø// ---- FEED (home page) -----
async function loadHomeFeed() {
    await window.waitForSupabase();
    const feed = document.getElementById("feed-container");
    feed.innerHTML = "<p style='text-align:center;color:#777'>Carregando feed...</p>";

    const user = await getCurrentUser();
    if (!user) {
        feed.innerHTML = `
            <div style="text-align:center; padding:40px;">
                <img src="logo.png" style="width:140px; opacity:0.95; margin-bottom:20px;">
                <p style="font-size:18px; color:#444; margin-top:10px;">
                    Entre para ver seus rol√™s.
                </p>
            </div>`;
        return;
    }

    // 1) Load all routes
    const { data: routes, error: routesError } = await getSupa()
        .from('routes')
        .select('*')
        .order('created_at', { ascending:false });

    if (routesError) {
        console.error(routesError);
        feed.innerHTML = "<p>Erro ao carregar feed</p>";
        return;
    }

    if (!routes || !routes.length) {
        feed.innerHTML = "<p style='padding:20px;text-align:center;'>Nenhum rol√™ encontrado.</p>";
        return;
    }

    // 2) Load all related profiles
    const ids = [...new Set(routes.map(r => r.user_id))];
    const { data: profiles } = await getSupa()
        .from('profiles')
        .select('*')
        .in('id', ids);

    const profileMap = {};
    profiles?.forEach(p => { profileMap[p.id] = p; });

    // 3) Attach profile to each route
    routes.forEach(route => {
        const userProfile = profileMap[route.user_id];
        route.profiles = userProfile ? {
            name: userProfile.name,
            photo_url: userProfile.photo_url
        } : {
            name: "Usu√°rio",
            photo_url: "https://i.pravatar.cc/150"
        };
    });

    const data = routes;

    feed.innerHTML = data.map(route => {
        const userName = route.profiles?.name || "Usu√°rio";
        const userAvatar = route.profiles?.photo_url || "https://i.pravatar.cc/100";
        const coverPhoto = route.photos?.[0]?.url || "";
        const timeAgo = timeSince(new Date(route.created_at));

        return `
        <div class="feed-card" data-route-id="${route.route_id}">
            <div class="feed-user-row">
                <img class="feed-avatar" src="${userAvatar}">
                <div>
                    <div class="feed-username">${userName}</div>
                    <div class="feed-time">${timeAgo}</div>
                </div>
            </div>
            <div class="feed-title">${route.title || "Meu rol√™"}</div>
            <img class="feed-map-img" src="${coverPhoto}" />
            <div class="feed-metrics">
                <div class="feed-metric-box">
                    <div class="feed-metric-label">Dist√¢ncia</div>
                    <div class="feed-metric-value">‚Äî</div>
                </div>
                <div class="feed-metric-box">
                    <div class="feed-metric-label">Tempo</div>
                    <div class="feed-metric-value">‚Äî</div>
                </div>
                <div class="feed-metric-box">
                    <div class="feed-metric-label">Pontos</div>
                    <div class="feed-metric-value">${route.photos?.length || 0}</div>
                </div>
            </div>
            <div class="feed-actions">
                <button class="feed-like"><i class="fa fa-heart"></i> 24</button>
                <button class="feed-comment"><i class="fa fa-comment"></i> 5</button>
                <button class="feed-share"><i class="fa fa-share"></i></button>
            </div>
        </div>`;
    }).join('');

    document.querySelectorAll('.feed-card').forEach(card => {
        card.onclick = () => {
            const id = card.dataset.routeId;
            window.location.href = `?open=${id}`;
        };
    });
}

function timeSince(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    const intervals = [
        { label:'h', seconds:3600 },
        { label:'min', seconds:60 }
    ];
    for (const it of intervals) {
        const v = Math.floor(seconds / it.seconds);
        if (v >= 1) return `${v} ${it.label} atr√°s`;
    }
    return "agora";
}
    </script>
