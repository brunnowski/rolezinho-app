<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Rolezinho</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial;
    overflow: hidden;
    background: black;
    overscroll-behavior: none;
    touch-action: none;
  }
  #map {
    position: fixed; inset: 0;
    z-index: 1;
    transform: translateZ(0);
    will-change: transform;
  }

  /* Bottom navigation */
  #bottomTabs {
    position: fixed; bottom: 0; left: 0; right: 0;
    height: 70px;
    background: rgba(0,0,0,0.9);
    border-top: 1px solid rgba(255,255,255,0.15);
    display: flex; justify-content: space-around; align-items: center;
    z-index: 10000;
  }
  #bottomTabs button {
    flex: 1; height: 100%;
    background: none; border: none; color: white;
    font-size: 26px; cursor: pointer;
  }

  /* Central camera button */
  #tabUpload {
    position: absolute;
    bottom: 35px; left: 50%; transform: translateX(-50%);
    width: 75px; height: 75px;
    border-radius: 50%;
    border: none; color: white;
    background: #0066ff;
    font-size: 32px;
    display: flex; justify-content: center; align-items: center;
    z-index: 10001;
    animation: pulse 2s infinite ease-in-out;
  }
  @keyframes pulse {
    0% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(1.08); }
    100% { transform: translateX(-50%) scale(1); }
  }

  /* Panels */
  .panel {
    position: fixed; inset: 0;
    background: black; color: white;
    z-index: 9999;
    display: none; flex-direction: column;
    padding: 20px; overflow-y: auto;
    transform: translateZ(0);
    will-change: transform;
  }
  .panel.active { display: flex; }

  .role-card {
    background: #111;
    padding: 16px; border-radius: 12px;
    margin-bottom: 14px;
    border: 1px solid #333;
  }

  #mapPanel { padding:0; }
  #mapPanel #map { position:absolute; inset:0; }
  #floatingCameraBtn {
    position: absolute;
    bottom: calc(90px + env(safe-area-inset-bottom));
    right: 20px;
    width: 65px;
    height: 65px;
    border-radius: 50%;
    background: #0066ff;
    color: white;
    font-size: 28px;
    border:none;
    display:flex;
    align-items:center;
    justify-content:center;
    animation: pulse 2s infinite ease-in-out;
    z-index: 10002;
  }
  .thumbnail {
    max-width: 100%;
    max-height: 150px;
    border-radius: 8px;
  }
  .spinner {
    border: 6px solid rgba(255, 255, 255, 0.2);
    border-top: 6px solid #0066ff;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div id="mapPanel" class="panel active">
  <div id="map" style="flex:1;"></div>
  <button id="floatingCameraBtn">
    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
      <path d="M23 19V7a2 2 0 0 0-2-2h-3l-2-3H8L6 5H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2z"/>
      <circle cx="12" cy="13" r="4"/>
    </svg>
  </button>
</div>

<!-- FEED -->
<div id="feedPanel" class="panel">
  <h2 style="margin-bottom:20px;">Meus Rolês</h2>
  <div id="feedList"></div>
</div>

<!-- PROFILE -->
<div id="profilePanel" class="panel">
  <h2 style="margin-bottom:10px;">Meu Perfil</h2>
  <p><strong>Nome:</strong> <span id="profileName">Visitante</span></p>
  <p><strong>Username:</strong> <span id="profileUser">guest</span></p>
  <p><strong>Email:</strong> <span id="profileEmail">—</span></p>

  <h3 style="margin-top:25px;">Meus Rolês</h3>
  <div id="profileRoles"></div>
</div>

<div id="bottomTabs">
  <button id="tabFeed"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M3 9l9-7 9 7"/><path d="M9 22V12h6v10"/></svg></button>
  <button id="tabMap"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M1 6l7-3 8 3 7-3v14l-7 3-8-3-7 3z"/></svg></button>
  <button id="tabProfile"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M5.5 21c1.5-4 11.5-4 13 0"/></svg></button>
</div>

<input id="uploadInput" type="file" accept="image/*,video/*" multiple style="display:none;">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
/* --- Minimal Supabase Setup --- */
const supabaseClient = supabase.createClient(
  'https://qjanxtpcszdinwxdrmpc.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYW54dHBjc3pkaW53eGRybXBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTI2NzUsImV4cCI6MjA3OTE4ODY3NX0.AZUMTReBfk1IR32RCGGZiuR-NpsxzBRkeWItTFCR444'
);

let currentProfile = null;
let waypoints = [];
let markers = [];
let currentRoute = null;

/* --- Auto Profile Creation --- */
async function ensureProfile() {
  if (currentProfile) return currentProfile;

  const { data } = await supabaseClient
    .from("profiles")
    .insert({
      name: "Visitante",
      username: "guest_" + Date.now(),
      email: null
    })
    .select()
    .single();

  currentProfile = data;
  return data;
}

/* --- MAP --- */
const map = L.map('map', {
  zoomControl: true,
  attributionControl: false,
  tap: false,
  inertia: true,
  inertiaDeceleration: 3000
}).setView([-27.5954, -48.5480], 13);

L.tileLayer('https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png').addTo(map);

/* PANELS */
const feedPanel = document.getElementById("feedPanel");
const profilePanel = document.getElementById("profilePanel");
const mapPanel = document.getElementById("mapPanel");

/* NAVIGATION */
document.getElementById("tabMap").onclick = () => {
  mapPanel.classList.add("active");
  feedPanel.classList.remove("active");
  profilePanel.classList.remove("active");
  document.getElementById("floatingCameraBtn").style.display = "flex";
};
document.getElementById("tabFeed").onclick = () => {
  feedPanel.classList.add("active");
  mapPanel.classList.remove("active");
  profilePanel.classList.remove("active");
  document.getElementById("floatingCameraBtn").style.display = "none";
  renderFeed();
};
document.getElementById("tabProfile").onclick = () => {
  profilePanel.classList.add("active");
  feedPanel.classList.remove("active");
  mapPanel.classList.remove("active");
  document.getElementById("floatingCameraBtn").style.display = "none";
  renderProfile();
};

document.getElementById("floatingCameraBtn").onclick = () => {
  const input = document.getElementById("uploadInput");
  if (input) input.click();
};

/* UPLOADER */
// UPLOAD HANDLER (EXIF extraction + preview, no auto-save)
document.getElementById("uploadInput").addEventListener("change", async (e) => {
  const files = Array.from(e.target.files);
  if (!files.length) return;

  // Loading UI while processing
  const loadingDiv = document.createElement('div');
  loadingDiv.innerHTML = '<div class="spinner"></div><p style="text-align:center; margin-top:10px;">Processando mídias...</p>';
  loadingDiv.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:99998; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white;';
  document.body.appendChild(loadingDiv);

  waypoints = [];
  clearMap();

  for (let file of files) {
    // Skip long videos (keep short clips only)
    if (file.type.startsWith('video')) {
      try {
        const duration = await getVideoDuration(file);
        if (duration > 4) continue;
      } catch (e) {
        console.warn('Não foi possível ler duração do vídeo, ignorando se muito grande', e);
      }
    }

    const exif = await window.exifr.gps(file).catch(() => null);
    if (exif?.latitude && exif?.longitude) {
      const base64 = await fileToBase64(file);
      const ts = exif?.DateTimeOriginal || new Date(file.lastModified);

      waypoints.push({
        lat: exif.latitude,
        lon: exif.longitude,
        name: file.name,
        thumbnail: base64,
        isVideo: file.type.startsWith('video'),
        ts
      });
    }
  }

  // Sort temporally
  waypoints.sort((a, b) => new Date(a.ts) - new Date(b.ts));

  // Render on map (preview)
  renderWaypoints();

  document.body.removeChild(loadingDiv);

  // Show floating save button
  showSaveButton();

  // reset input
  e.target.value = '';
});

/* FEED RENDER */
async function renderFeed() {
  ensureProfile();
  feedPanel.classList.add("active");

  const { data: roles } = await supabaseClient
    .from("roles")
    .select("id, titulo, created_at")
    .order("created_at", { ascending: false });

  const list = document.getElementById("feedList");
  list.innerHTML = roles.map(r => `
    <div class="role-card">
      <h3>${r.titulo}</h3>
      <p>${new Date(r.created_at).toLocaleString()}</p>
      <button onclick="openRole('${r.id}')">Abrir</button>
    </div>
  `).join("");
}

/* PROFILE RENDER */
async function renderProfile() {
  const profile = await ensureProfile();
profilePanel.classList.add("active");

document.getElementById("profileName").textContent = profile.name || 'Visitante';
document.getElementById("profileUser").textContent = profile.username || 'guest';
document.getElementById("profileEmail").textContent = profile.email || '—';

  const { data: roles } = await supabaseClient
    .from("roles")
    .select("id, titulo, created_at")
    .eq("profile_id", currentProfile.id)
    .order("created_at", { ascending: false });

  document.getElementById("profileRoles").innerHTML = roles.map(r => `
    <div class="role-card">
      <h3>${r.titulo}</h3>
      <button onclick="openRole('${r.id}')">Abrir</button>
      <button onclick="shareRole('${r.id}')">Compartilhar</button>
    </div>
  `).join("");
}

/* HELPERS */
async function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = (err) => reject(err);
    reader.readAsDataURL(file);
  });
}

async function compressImage(base64, maxWidth = 480) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const scale = maxWidth / img.width;
      canvas.width = maxWidth;
      canvas.height = Math.max(1, Math.round(img.height * scale));
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      resolve(canvas.toDataURL('image/jpeg', 0.6));
    };
    img.onerror = () => resolve(base64);
    img.src = base64;
  });
}

async function getVideoDuration(file) {
  return new Promise(resolve => {
    const video = document.createElement('video');
    video.preload = 'metadata';
    video.onloadedmetadata = () => {
      URL.revokeObjectURL(video.src);
      resolve(video.duration);
    };
    video.onerror = () => resolve(0);
    video.src = URL.createObjectURL(file);
  });
}

window.openRole = async id => {
  location.href = location.pathname + "?role=" + id;
};

window.shareRole = id => {
  navigator.clipboard.writeText(location.origin + location.pathname + "?role=" + id);
  alert("Link copiado!");
};

function showSaveButton() {
  if (document.getElementById('saveRouteFloating')) return;
  const btn = document.createElement('button');
  btn.id = 'saveRouteFloating';
  btn.textContent = '';
  const icon = document.createElement('svg');
  icon.setAttribute('width', '20');
  icon.setAttribute('height', '20');
  icon.setAttribute('viewBox', '0 0 24 24');
  icon.setAttribute('fill', 'none');
  icon.setAttribute('stroke', 'white');
  icon.setAttribute('stroke-width', '2');

  const path1 = document.createElement('path');
  path1.setAttribute('d', 'M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z');
  const poly1 = document.createElement('polyline');
  poly1.setAttribute('points', '17 21 17 13 7 13 7 21');
  const poly2 = document.createElement('polyline');
  poly2.setAttribute('points', '7 3 7 8 15 8');

  icon.appendChild(path1);
  icon.appendChild(poly1);
  icon.appendChild(poly2);

  btn.appendChild(icon);
  const textNode = document.createTextNode(' Salvar Rolê');
  btn.appendChild(textNode);
  btn.style.cssText = 'position:fixed; bottom:120px; left:50%; transform:translateX(-50%); z-index:10003; padding:12px 18px; border-radius:999px; background:#0066ff; color:white; border:none; font-weight:600;';
  btn.addEventListener('click', () => {
    // open title modal
    const suggested = 'Meu Rolê ' + new Date().toLocaleDateString();
    window.pendingWaypoints = waypoints.slice();
    window.openRouteTitleModal(suggested);
  });
  document.body.appendChild(btn);
}
function hideSaveButton() { const b = document.getElementById('saveRouteFloating'); if (b) b.remove(); }

async function savePendingRoute() {
  try {
    if (!window.pendingWaypoints || !window.pendingRouteTitle) return;
    const profile = window.currentProfile || await ensureProfile();
    const titulo = window.pendingRouteTitle;

    showLoadingOverlay('Salvando rolê...');

    const role = await createRoleOnSupabase({ titulo, creator_name: profile.name || profile.username || 'Visitante', creator_photo: profile.photo_url || null, profile_id: profile.id });
    const roleId = role.id;

    const waypointsPrepared = [];
    for (let wp of window.pendingWaypoints) {
      let thumbURL = null;
      if (!wp.isVideo) {
        const compressed = await compressImage(wp.thumbnail, 600);
        thumbURL = await uploadThumbnailToSupabase(compressed, roleId, wp.name);
      }
      waypointsPrepared.push({ lat: wp.lat, lon: wp.lon, name: wp.name, thumbnail_url: thumbURL, is_video: !!wp.isVideo, ts: wp.ts });
    }

    await insertWaypointsBulk(roleId, waypointsPrepared);

    hideLoadingOverlay();
    showToast('Rolê salvo com sucesso!');
    window.lastSavedRoleId = roleId;
    hideSaveButton();
    renderFeed();

    // cleanup
    window.pendingWaypoints = null;
    window.pendingRouteTitle = null;
  } catch (err) {
    console.error('Erro ao salvar rolê:', err);
    hideLoadingOverlay();
    showToast('Erro ao salvar o rolê');
  }
}
function showLoadingOverlay(message = 'Carregando...') {
  if (document.getElementById('rx-loading-overlay')) return;

  const overlay = document.createElement('div');
  overlay.id = 'rx-loading-overlay';
  overlay.style.cssText = `
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.6); z-index:100000; color:white; padding:20px; backdrop-filter:blur(6px);
  `;
  overlay.innerHTML = `
    <div style="text-align:center; max-width:320px; width:100%;">
      <div class="spinner" style="margin:0 auto 12px;"></div>
      <div style="font-size:16px; opacity:0.95;">${message}</div>
    </div>
  `;
  document.body.appendChild(overlay);
}

function hideLoadingOverlay() {
  const el = document.getElementById('rx-loading-overlay');
  if (el) el.remove();
}
/* Clear map markers and route */
function clearMap() {
  // Remove markers and current route cleanly
  // Remove all marker layers
  if (markers && markers.length) {
    markers.forEach(m => { if (m && map.hasLayer(m)) map.removeLayer(m); });
  }
  markers = [];

  // Remove polyline route
  if (currentRoute && map.hasLayer(currentRoute)) {
    map.removeLayer(currentRoute);
    currentRoute = null;
  }
}

/* Render waypoints with markers and route */
function renderWaypoints() {
  // Render markers, popups, and request OSRM for route; auto-fit bounds
  clearMap();
  const bounds = [];

  waypoints.forEach((wp, i) => {
    const marker = L.marker([wp.lat, wp.lon]).addTo(map);
    markers.push(marker);

    const mediaHTML = wp.isVideo
      ? `<video src="${wp.thumbnail}" class="thumbnail" autoplay loop muted playsinline preload="metadata"></video>`
      : `<img src="${wp.thumbnail}" class="thumbnail" loading="lazy">`;

    marker.bindPopup(`
      <div style="text-align:center; min-width:200px;">
        <b>${wp.name}</b><br>
        ${mediaHTML}<br>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
          <button onclick="window.focusMarker(${i - 1})" style="flex:1;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <button onclick="window.focusMarker(${i + 1})" style="flex:1;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        </div>
      </div>
    `);

    marker.on('popupopen', (e) => {
      setTimeout(() => {
        const popup = e.popup._container;
        if (!popup) return;
        const h = popup.offsetHeight;
        map.panBy([0, -h / 3], { animate: true, duration: 0.3 });
      }, 60);
    });

    marker.on('click', () => {
      map.setView(marker.getLatLng(), 15, { animate: true });
      marker.openPopup();
    });

    bounds.push([wp.lat, wp.lon]);
  });

  if (bounds.length > 0) {
    map.once('moveend', () => {
      if (waypoints.length > 1) {
        const coords = waypoints.map(w => `${w.lon},${w.lat}`).join(';');
        fetch(`https://router.project-osrm.org/route/v1/foot/${coords}?overview=full&geometries=geojson`)
          .then(r => r.json())
          .then(data => {
            if (!data || data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
              console.warn('OSRM: rota indisponível', data);
              return;
            }
            const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
            if (currentRoute && map.hasLayer(currentRoute)) map.removeLayer(currentRoute);
            currentRoute = L.polyline(routeCoords, { color: '#0066ff', weight: 4, opacity: 0.9 }).addTo(map);
          })
          .catch(err => console.error('Erro ao carregar rota OSRM:', err));
      }
    });

    map.flyToBounds(bounds, {
      paddingTopLeft: [0, 80],
      paddingBottomRight: [0, 110],
      maxZoom: 15,
      animate: true,
      duration: 0.91,
      easeLinearity: 0.2
    });
  }

  // auto-open popup when only one marker
  if (markers.length === 1) {
    setTimeout(() => {
      markers[0].openPopup();
      map.setView(markers[0].getLatLng(), 16, { animate: true });
    }, 200);
  }
}
</script>

  <!-- ROUTE TITLE MODAL -->
  <div id="routeTitleModal" class="panel" style="display:none; z-index:20000;">
    <h2>Nome do Rolê</h2>
    <p>Escolha um título para sua rota.</p>
    <input id="routeTitleInput" type="text" placeholder="Meu Rolê" style="padding:12px; border-radius:8px; border:none; margin-bottom:20px; width:100%;">
    <button id="confirmRouteTitle" style="padding:12px; border-radius:8px; width:100%; margin-bottom:10px;">Continuar</button>
    <button id="cancelRouteTitle" class="btn-secondary" style="padding:12px; border-radius:8px; width:100%;">Cancelar</button>
  </div>

  <!-- ACCOUNT CREATION MODAL -->
  <div id="createAccountModal" class="panel" style="display:none; z-index:20001;">
    <h2>Criar Conta</h2>
    <input id="caUsername" type="text" placeholder="Username" style="padding:12px; border-radius:8px; border:none; margin-bottom:12px; width:100%;">
    <input id="caEmail" type="email" placeholder="Email" style="padding:12px; border-radius:8px; border:none; margin-bottom:12px; width:100%;">
    <input id="caPassword" type="password" placeholder="Senha" style="padding:12px; border-radius:8px; border:none; margin-bottom:20px; width:100%;">
    <button id="createAccountBtnFinal" style="padding:12px; border-radius:8px; width:100%; margin-bottom:10px;">Criar Conta</button>
    <button id="cancelCreateAccount" class="btn-secondary" style="padding:12px; border-radius:8px; width:100%;">Cancelar</button>
  </div>

<script>
// Show route title modal after user taps Save (trigger: role creation process)
window.openRouteTitleModal = function(suggestedTitle) {
  document.getElementById("routeTitleInput").value = suggestedTitle || "";
  document.getElementById("routeTitleModal").style.display = "flex";
};

document.getElementById("cancelRouteTitle").onclick = () => {
  document.getElementById("routeTitleModal").style.display = "none";
};

document.getElementById("confirmRouteTitle").onclick = () => {
  const title = document.getElementById("routeTitleInput").value.trim();
  if (!title) return alert("Escolha um título.");
  document.getElementById("routeTitleModal").style.display = "none";
  document.getElementById("createAccountModal").style.display = "flex";
  window.pendingRouteTitle = title;
};

// ACCOUNT CREATION
document.getElementById("cancelCreateAccount").onclick = () => {
  document.getElementById("createAccountModal").style.display = "none";
};

document.getElementById("createAccountBtnFinal").onclick = async () => {
  const username = document.getElementById("caUsername").value.trim();
  const email = document.getElementById("caEmail").value.trim();
  const password = document.getElementById("caPassword").value.trim();

  if (!username || !email || !password) { 
    alert("Preencha todos os campos."); 
    return; 
  }

  // STEP 1 — Create user in Supabase Auth
  const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
    email,
    password
  });

  if (signUpError) {
    alert("Erro ao criar conta.");
    console.error(signUpError);
    return;
  }

  const authId = signUpData.user?.id;

  // Do NOT manually insert into profiles — trigger will handle it
  window.currentProfile = {
    auth_uid: authId,
    username,
    email,
    name: username
  };

  // Close modal
  document.getElementById('createAccountModal').style.display = 'none';
  alert('Conta criada! Salvando seu rolê...');

  // STEP 2 — Continue saving the pending route
  await savePendingRoute();
};
</script>
</body>
</html>
