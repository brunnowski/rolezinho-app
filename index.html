<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rolezinho App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <style>
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden;
            background: #f4f8fb;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        #app-content {
            height: calc(100dvh - 65px);
            padding-bottom: 65px;
            box-sizing: border-box;
        }
        .bottom-menu {
            position: fixed;
            z-index: 900;
            left: 0; right: 0; bottom: 0;
            height: 65px;
            background: #fff;
            box-shadow: 0 -2px 15px rgba(60, 60, 60, 0.08);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }
        .bottom-menu button {
            background: none;
            border: none;
            flex: 1 1 0;
            color: #777;
            font-size: 14px;
            padding: 8px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: color 0.17s;
            outline: none;
            cursor: pointer;
        }
        .bottom-menu button.active, .bottom-menu button:focus {
            color: #2196F3;
        }
        .bottom-menu i {
            font-size: 22px;
        }
        /* MAP PAGE */
        #map {
            height: calc(100dvh - 65px);
            width: 100vw;
            position: relative;
            z-index: 1;
        }
        /* Thumbnail carousel - mobile first */
        #thumb-carousel {
            position: fixed;
            left: 0; right: 0; bottom: 150px; /* above floating button */
            height: 86px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            box-sizing: border-box;
            z-index: 1002;
            pointer-events: none;
        }
        .thumbs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 6px 0;
            flex: 1 1 auto;
            scroll-snap-type: x mandatory;
            pointer-events: auto;
        }
        .thumbs::-webkit-scrollbar{ height:8px }
        .thumb {
            flex: 0 0 auto;
            width: 72px;
            height: 72px;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            scroll-snap-align: center;
            position: relative;
            border: 2px solid transparent;
        }
        .thumb img{ width:100%; height:100%; object-fit:cover; display:block }
        .thumb.active{ border-color:#2196F3 }
        .thumb .index-badge{
            position:absolute; right:6px; top:6px; background:rgba(0,0,0,0.45); color:#fff; font-size:11px; padding:3px 6px; border-radius:10px
        }
        .thumb-nav{
            background: rgba(255,255,255,0.95);
            border: none;
            width: 36px; height:36px; border-radius:18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 20px; line-height:0; display:flex; align-items:center; justify-content:center;
            pointer-events: auto;
        }
        .floating-btn {
            position: fixed;
            bottom: 85px;
            right: 24px;
            z-index: 1001;
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(52,108,199,0.19);
            width: 58px;
            height: 58px;
            font-size: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .floating-btn input[type="file"] {
            display: none;
        }
        /* Auth modal */
#auth-modal { display:none; position:fixed; left:0; top:0; right:0; bottom:0; z-index:2000; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); }
#auth-modal .modal-inner { width:92%; max-width:420px; background:#fff; padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
#auth-modal input[type="email"], #auth-modal input[type="password"]{ width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ddd; box-sizing:border-box }
#auth-modal .auth-actions{ display:flex; gap:8px; margin-top:12px }
#auth-modal button{ flex:1; padding:10px; border-radius:8px; border:none }
        /* Simple Home/Profile styling */
        .simple-page {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 2em;
            color: #444;
        }
        .route-list {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .route-card {
            display: flex;
            background: #fff;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            cursor: pointer;
        }

        .route-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 12px;
        }

        .route-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .route-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .route-date {
            font-size: 13px;
            color: #666;
        }
        @media (max-width:600px) {
            .floating-btn { right: 12px; bottom: 78px;}
            .bottom-menu { height: 58px; }
            #map { height: calc(100dvh - 58px); }
        }
    </style>
</head>
<body>
    <div id="app-content">
        <div id="home-page" class="simple-page">üè† HOME</div>
        <div id="map-page" style="display:none; height:100%">
            <div id="map"></div>
            <!-- THUMBNAIL CAROUSEL (mobile-first) -->
            <div id="thumb-carousel" style="display:none" aria-hidden="false">
                <button id="thumb-prev" class="thumb-nav" aria-label="Anterior">‚Äπ</button>
                <div id="thumbs" class="thumbs" role="list"></div>
                <button id="thumb-next" class="thumb-nav" aria-label="Pr√≥ximo">‚Ä∫</button>
            </div>
            <button id="add-photos-btn" class="floating-btn" title="Adicionar Fotos">
                <i class="fa fa-camera"></i>
                <input type="file" accept="image/*,video/*" multiple id="photo-upload-input">
            </button>
        </div>
        <div id="profile-page" class="simple-page" style="display:none">üë§ PROFILE</div>
    </div>
    <!-- SAVE ROUTE BUTTON (shows after route plotted) -->
<div id="save-rol√™-container" style="position:fixed; left:16px; right:16px; bottom:240px; z-index:1003; display:none; justify-content:space-between; gap:8px;">
  <button id="edit-route-btn" style="flex:0 0 58px; height:58px; border-radius:12px; border:none; background:#ffffff; box-shadow:0 6px 18px rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:center;">
    <!-- pencil icon -->
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
  </button>
  <button id="save-route-btn" style="flex:1; padding:12px 16px; border-radius:12px; border:none; background:#1e88e5; color:#fff; font-size:16px; box-shadow:0 6px 18px rgba(30,136,229,0.18); display:flex; align-items:center; justify-content:center; gap:6px;">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    Salvar
  </button>
</div>
    <nav class="bottom-menu">
        <button id="nav-home" class="active"><i class="fa fa-home"></i><span>Home</span></button>
        <button id="nav-map"><i class="fa fa-map"></i><span>Map</span></button>
        <button id="nav-profile"><i class="fa fa-user"></i><span>Profile</span></button>
    </nav>
    <!-- AUTH MODAL -->
<div id="auth-modal">
  <div class="modal-inner">
    <h3 style="margin-top:0">Entrar ou Criar Conta</h3>
    <input id="auth-email" type="email" placeholder="Seu email" />
    <input id="auth-pass" type="password" placeholder="Sua senha" />
    <p style="font-size:13px; color:#555; margin-top:6px;">
      Ao criar uma conta, voc√™ concorda com os
      <a href="https://app.kortex.co/public/document/0e51d08e-1574-4b7a-be8a-ca39fb346a9c" target="_blank" style="color:#1e88e5; text-decoration:underline;">
        Termos de Uso
      </a>.
    </p>
    <div class="auth-actions">
      <button id="auth-login-btn" style="background:#1e88e5; color:#fff;">Login</button>
      <button id="auth-signup-btn" style="background:#43a047; color:#fff;">Criar conta</button>
    </div>
  </div>
</div>
    <!-- LIBS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- EXIF Reader (tiny) -->
    <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/full.umd.js"></script>
    <!-- Supabase JS client via ES module -->
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const SUPABASE_URL = "https://qjanxtpcszdinwxdrmpc.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYW54dHBjc3pkaW53eGRybXBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTI2NzUsImV4cCI6MjA3OTE4ODY3NX0.AZUMTReBfk1IR32RCGGZiuR-NpsxzBRkeWItTFCR444";

      window.supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
    <script>
        // Tab switching logic
        function showPage(page) {
            document.getElementById('home-page').style.display = (page === 'home') ? '' : 'none';
            document.getElementById('map-page').style.display = (page === 'map') ? '' : 'none';
            document.getElementById('profile-page').style.display = (page === 'profile') ? '' : 'none';
            document.getElementById('nav-home').classList.toggle('active', page === 'home');
            document.getElementById('nav-map').classList.toggle('active', page === 'map');
            document.getElementById('nav-profile').classList.toggle('active', page === 'profile');
            if (page === 'map' && typeof renderMap === 'function') setTimeout(renderMap, 200);
        }
document.getElementById('nav-home').onclick = async ()=>{
  if (pendingSave) { showAuthModal(); return; }
  showPage('home');
};
document.getElementById('nav-map').onclick = ()=>showPage('map');
document.getElementById('nav-profile').onclick = async () => {
  showPage('profile');
  await loadUserRoutes();
};

        // ---- MAP & PHOTOS -----
        // Auto‚Äërestore the map when redirected with ?auth=1
        document.addEventListener('DOMContentLoaded', async ()=>{
          const params = new URLSearchParams(window.location.search);
          if(params.has('auth')){
            showPage('map');
            await afterAuthAutoSave();
            history.replaceState({}, '', window.location.origin);
          }
        });
        let map, routeLayer, markersLayer, waypoints = [];
        let markers = []; // store L.marker references
let currentThumbIndex = 0;

// ===== Supabase (window.supa is set by ES module above) =====

// pending save state: store the last exifArr the user attempted to save
let pendingSave = null;

        function renderMap() {
            if (!map) {
                map = L.map('map', { center:[-23.5505, -46.6333], zoom:13, gestureHandling: true });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);
                markersLayer = L.layerGroup().addTo(map);
                routeLayer = L.layerGroup().addTo(map);
            }
            setTimeout(()=>{ map.invalidateSize(); }, 80);
        }

        // --- FLOATING BUTTON -- 
        const addPhotosBtn = document.getElementById('add-photos-btn');
        const photoInput = document.getElementById('photo-upload-input');

        addPhotosBtn.onclick = () => { photoInput.click(); };
        addPhotosBtn.addEventListener('touchend', e=>{
            e.preventDefault(); photoInput.click();
        });

        photoInput.addEventListener('change', async function(e){
            if (!photoInput.files.length) return;
            // parse all images/videos
            let allExif = [];
            for (const file of photoInput.files) {
                const isVideo = file.type.startsWith("video/");
                try {
                    const exif = await exifr.parse(file, { gps: true, tiff: true });
                    if (exif && exif.latitude && exif.longitude) {
                        allExif.push({
                            file,
                            lat: exif.latitude,
                            lng: exif.longitude,
                            date: exif.DateTimeOriginal || exif.CreateDate || file.lastModified,
                            name: file.name,
                            isVideo: isVideo
                        });
                    } else {
                        alert(`A m√≠dia "${file.name}" n√£o possui metadados de localiza√ß√£o e ser√° ignorada.`);
                    }
                } catch(e) {
                    alert(`A m√≠dia "${file.name}" n√£o possui metadados de localiza√ß√£o e ser√° ignorada.`);
                }
            }
            if (allExif.length < 1) {
                alert('Nenhuma m√≠dia v√°lida com localiza√ß√£o foi encontrada.');
                return;
            }

            // sort oldest to newest
            allExif.sort((a,b)=>{
                return new Date(a.date) - new Date(b.date);
            });
            waypoints = allExif.map(ex=>({lat: ex.lat, lng: ex.lng}));
            plotWaypointsAndRoute(allExif);
        });

        async function plotWaypointsAndRoute(exifArr) {
            document.getElementById('thumb-carousel').style.display = 'none';
            setSaveButtonVisible(false);
            if (!map) renderMap();
            routeLayer.clearLayers();
            markersLayer.clearLayers();
            // clear old markers and revoke object urls
            markers.forEach(m=>{ if(m._thumbUrl){ URL.revokeObjectURL(m._thumbUrl); } });
            markers = [];
            // Place markers and collect marker objects
            exifArr.forEach((ex, idx)=>{
                const isStart = idx === 0;
                const isEnd = idx === exifArr.length - 1;
                const icon = isStart
                    ? L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize: [36,36], className: 'start-marker' })
                    : isEnd
                        ? L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize: [36,36], className: 'end-marker' })
                        : undefined;
                const marker = L.marker([ex.lat, ex.lng], icon ? {icon} : undefined)
                               .bindPopup(`${isStart ? 'In√≠cio' : isEnd ? 'Fim' : 'Waypoint'}<br>${ex.name}`);
                marker.addTo(markersLayer);
                marker._exif = ex; // attach original file/meta
                markers.push(marker);

                // when marker clicked open the corresponding thumbnail (centered)
                marker.on('click', ()=>{
                    const i = markers.indexOf(marker);
                    if(i>=0) openThumbnailAt(i);
                });
            });

            // If only one media, skip OSRM routing entirely
            if (exifArr.length === 1) {
                // Center map on the single marker
                const single = exifArr[0];
                if (markers[0]) {
                    map.setView([single.lat, single.lng], 16);
                    markers[0].openPopup();
                }
                // Render thumbnails normally
                renderThumbnails(exifArr);
                currentThumbIndex = 0;
                openThumbnailAt(0);
                return; // do NOT try to build a route
            }
            // Build OSRM Route request (same as before)
            const coordsStr = exifArr.map(ex=>`${ex.lng},${ex.lat}`).join(';');
            const url = `https://router.project-osrm.org/route/v1/foot/${coordsStr}?overview=full&geometries=geojson`;
            try {
                const resp = await fetch(url);
                const data = await resp.json();
                if (data.code === 'Ok' && data.routes.length) {
                    const route = data.routes[0].geometry;
                    const poly = L.geoJSON(route, {color: '#0099ff', weight:5, opacity:0.75}).addTo(routeLayer);
                    map.fitBounds(poly.getBounds(), { padding: [60,60] });
                } else {
                    alert('N√£o foi poss√≠vel tra√ßar a rota.');
                }
            } catch(e) {
                alert('Erro ao conectar ao servi√ßo de rotas: ' + e.message);
            }

            // Render thumbnails and enable navigation
            renderThumbnails(exifArr);
            // open first thumbnail by default (center popup)
            currentThumbIndex = 0;
            openThumbnailAt(0);
        }

        // Render thumbnails into the carousel and wire click handlers
        function renderThumbnails(exifArr){
            document.getElementById('thumb-carousel').style.display = 'flex';
            setSaveButtonVisible(true);
            const thumbs = document.getElementById('thumbs');
            thumbs.innerHTML = '';
            exifArr.forEach((ex, idx)=>{
                const url = URL.createObjectURL(ex.file);
                const el = document.createElement('div');
                el.className = 'thumb';
                el.dataset.index = idx;
                el.innerHTML = `<img src="${url}" alt="thumb-${idx}" /><div class="index-badge">${idx+1}</div>`;
                el.addEventListener('click', ()=>{ openThumbnailAt(idx); });
                thumbs.appendChild(el);
                // store thumb url on marker so we can revoke later
                if(markers[idx]) markers[idx]._thumbUrl = url;
            });

            // wire prev/next buttons
            const prev = document.getElementById('thumb-prev');
            const next = document.getElementById('thumb-next');
            prev.onclick = ()=>{ navigateThumb(-1); };
            next.onclick = ()=>{ navigateThumb(1); };

            // make sure carousel is scrollable to active
            setTimeout(()=>{ scrollThumbIntoView(currentThumbIndex); }, 60);
        }

// --- Thumbnail drag reorder support ---
let editingRoute = false;

function enableThumbnailReorder(){
  const thumbs = document.getElementById('thumbs').children;
  [...thumbs].forEach(el=>{
    el.setAttribute('draggable','true');
    el.ondragstart = ev=>{ ev.dataTransfer.setData('idx', el.dataset.index); };
    el.ondragover = ev=> ev.preventDefault();
    el.ondrop = ev=>{
      ev.preventDefault();
      const from = Number(ev.dataTransfer.getData('idx'));
      const to = Number(el.dataset.index);
      if(from===to) return;
      const parent = document.getElementById('thumbs');
      const nodes = [...parent.children];
      const moved = nodes[from];
      parent.removeChild(moved);
      parent.insertBefore(moved, nodes[to]);
      const newOrder = [...parent.children].map(n=> markers[Number(n.dataset.index)]._exif);
      markers = markers.sort((a,b)=> newOrder.indexOf(a._exif) - newOrder.indexOf(b._exif));
    };
  });
}

function disableThumbnailReorder(){
  const thumbs = document.getElementById('thumbs').children;
  [...thumbs].forEach(el=>{
    el.removeAttribute('draggable');
    el.ondragstart = null;
    el.ondragover = null;
    el.ondrop = null;
  });
}

        function navigateThumb(delta){
            if(!markers.length) return;
            currentThumbIndex = (currentThumbIndex + delta + markers.length) % markers.length; // loop
            openThumbnailAt(currentThumbIndex);
        }

        function openThumbnailAt(idx){
            if(idx < 0 || idx >= markers.length) return;
            currentThumbIndex = idx;
            // highlight thumb
            const thumbs = document.querySelectorAll('.thumb');
            thumbs.forEach(t=> t.classList.toggle('active', Number(t.dataset.index)===idx));
            // scroll into view center
            scrollThumbIntoView(idx);
            // center map so popup shows centered on screen
            const marker = markers[idx];
            if(marker){
                const latlng = marker.getLatLng();
                // compute container center and move marker there so popup is centered
                const mapSize = map.getSize();
                const containerCenter = L.point(mapSize.x/2, mapSize.y/2 - 40); // slight upward offset
                const markerPoint = map.latLngToContainerPoint(latlng);
                const delta = markerPoint.subtract(containerCenter);
                const targetPoint = map.containerPointToLatLng(markerPoint.subtract(delta));
                map.panTo(targetPoint, {animate:true});
                marker.openPopup();
            }
        }

        function scrollThumbIntoView(idx){
            const el = document.querySelector(`.thumb[data-index="${idx}"]`);
            if(el){
                el.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
            }
        }
// ===== AUTH & SAVE HELPERS =====
// Show or hide the Save button (show when thumbnails exist)
function setSaveButtonVisible(visible){
    const container = document.getElementById('save-rol√™-container');
    container.style.display = visible ? 'flex' : 'none';
}

// Check for logged-in user
async function getCurrentUser(){
    const { data, error } = await supa.auth.getUser();
    if(error) return null;
    return data?.user || null;
}

// Show a simple modal to login/signup (we'll add markup later)
function showAuthModal(){
    const m = document.getElementById('auth-modal');
    if(m) m.style.display = 'flex';
}
function hideAuthModal(){
    const m = document.getElementById('auth-modal');
    if(m) m.style.display = 'none';
}

// signup with email + password (simple flow)
async function handleSignup(email, password){
    let redirectBase = window.location.origin;
    if (redirectBase.startsWith("file")) {
        redirectBase = "https://brunnowski.github.io/rolezinho-app";
    }
    const { data, error } = await supa.auth.signUp({
        email,
        password,
        options: {
            emailRedirectTo: redirectBase + '?auth=1'
        }
    });
    return { data, error };
}

async function handleSignin(email, password){
    const { data, error } = await supa.auth.signInWithPassword({ email, password });
    return { data, error };
}

// Save route + images to Supabase Storage and insert a record into 'routes' table
async function saveRouteToSupabase(exifArr){
    const user = await getCurrentUser();
    if(!user) {
        // trigger auth flow and set pending
        pendingSave = exifArr;
        showAuthModal();
        return;
    }

    const routeId = 'route_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
    // build points payload
    const points = exifArr.map((ex, i)=>({ lat: ex.lat, lng: ex.lng, order: i }));

    // Upload each photo to Supabase Storage
    const uploadedPhotos = [];
    for (let i=0;i<exifArr.length;i++){
        const file = exifArr[i].file;
        const filename = `${i}_${file.name}`;
        const path = `roles/${user.id}/${routeId}/${filename}`;
        try {
            const { data: uploadData, error: uploadError } = await supa.storage.from('roles').upload(path, file, { upsert: true });
            if(uploadError){
                console.error('Upload error', uploadError);
                continue;
            }
            const { data: publicUrlData } = supa.storage.from('roles').getPublicUrl(path);
            uploadedPhotos.push({ url: publicUrlData.publicUrl, order: i, filename });
        } catch(err){
            console.error('Upload exception', err);
        }
    }

    // Insert route record
    try{
        const { data: insertData, error: insertError } = await supa.from('routes').insert([{
            user_id: user.id,
            route_id: routeId,
            points: points,
            photos: uploadedPhotos,
            created_at: new Date().toISOString()
        }]);
        if(insertError){
            console.error('Insert error', insertError);
            alert('Erro ao salvar a rota. Veja o console para detalhes.');
            return;
        }
        alert('Rol√™ salvo com sucesso!');
        // hide Save UI
        setSaveButtonVisible(false);
    } catch(e){
        console.error(e);
        alert('Erro inesperado ao salvar.');
    }
}

// After successful login/signup, if pendingSave exists, auto-save
async function afterAuthAutoSave(){
    const user = await getCurrentUser();
    if(user && pendingSave){
        const exifArr = pendingSave;
        pendingSave = null;
        hideAuthModal();
        await saveRouteToSupabase(exifArr);
    }
}
// Save button handler
document.getElementById('save-route-btn').addEventListener('click', async ()=>{
    // collect the exif objects from markers (they are stored in markers[]. _exif)
    const exifArr = markers.map(m=>m._exif).filter(Boolean);
    if(!exifArr.length){ alert('Nenhuma rota dispon√≠vel'); return; }
    const user = await getCurrentUser();
    if(user){ showPage('map'); await saveRouteToSupabase(exifArr); return; }
    await saveRouteToSupabase(exifArr);
});

// EDIT ROUTE BUTTON HANDLER
const editBtn = document.getElementById('edit-route-btn');
editBtn.addEventListener('click', ()=>{
  editingRoute = !editingRoute;
  if(editingRoute){
    enableThumbnailReorder();
    editBtn.style.background = '#ffe28a';
  } else {
    disableThumbnailReorder();
    editBtn.style.background = '#ffffff';
  }
});

// Auth modal controls (signup / login)
// EVENT DELEGATION for dynamic modal buttons
document.getElementById('auth-modal').addEventListener('click', async (ev)=>{
    const el = ev.target;
    // Close modal when clicking outside modal-inner
    if (el.id === 'auth-modal') {
        hideAuthModal();
        return;
    }

    // LOGIN
    if(el.id === 'auth-login-btn'){
        const email = document.getElementById('auth-email')?.value;
        const pass = document.getElementById('auth-pass')?.value;
        if(!email || !pass){ alert('Preencha email e senha'); return; }
        const { error } = await handleSignin(email, pass);
        if(error){ alert('Erro no login: ' + error.message); return; }
        showPage('map');
        if(!pendingSave){ openThumbnailAt(0); }
        await afterAuthAutoSave();
    }

    // SIGNUP
    if(el.id === 'auth-signup-btn'){
        const email = document.getElementById('auth-email')?.value;
        const pass = document.getElementById('auth-pass')?.value;
        if(!email || !pass){ alert('Preencha email e senha'); return; }
        const { error } = await handleSignup(email, pass);
        if(error){ alert('Erro no cadastro: ' + error.message); return; }

        const inner = document.querySelector('#auth-modal .modal-inner');
        inner.innerHTML = `
            <h3 style="margin-top:0">Conta criada!</h3>
            <p style="font-size:15px;color:#444;margin-top:10px">
                Verifique seu email para confirmar sua conta e continuar salvando seu rol√™.
            </p>
            <button id="open-email-app" style="width:100%; padding:12px; margin-top:18px; border:none; border-radius:8px; background:#1e88e5; color:#fff; font-size:16px;">
                Abrir app de email
            </button>
            <p style="font-size:14px;color:#555;margin-top:16px">
                Ap√≥s confirmar, voc√™ retornar√° automaticamente √† sua √∫ltima rota.
            </p>
        `;

        setTimeout(()=>{
            const openBtn = document.getElementById('open-email-app');
            if(openBtn) openBtn.onclick = ()=>{
                let tried = false;

                // iOS Mail inbox (best for iPhone)
                tried = true;
                window.location.href = 'message://';

                // Gmail (Android) ‚Äì tries to open inbox instead of compose
                setTimeout(()=>{
                    if(tried){
                        window.location.href = 'googlegmail:///';
                    }
                }, 350);

                // Outlook (Android/iOS)
                setTimeout(()=>{
                    if(tried){
                        window.location.href = 'ms-outlook://';
                    }
                }, 700);

                // Fallback to 'mailto:' (opens app picker)
                setTimeout(()=>{
                    window.location.href = 'mailto:';
                }, 1100);
            };
        },50);
    }
});

// listen for auth state changes (for example email confirmation flow)
supa.auth.onAuthStateChange((event, session) => {
    if(event === 'SIGNED_IN'){
        // if this was a verification redirect, restore route
        if(pendingSave){ openThumbnailAt(0); }
        showPage('map');
        afterAuthAutoSave();
    }
});

// Show MAP by default on mobile PWAs if desired
        // showPage('map'); // Uncomment if you want to start at map

// --- Load user routes for profile page ---
async function loadUserRoutes() {
    const user = await getCurrentUser();
    if (!user) {
        document.getElementById('profile-page').innerHTML = `
            <div style="padding:20px; font-size:18px;">Fa√ßa login para ver suas rotas.</div>
        `;
        return;
    }

    const { data, error } = await supa
        .from('routes')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

    if (error) {
        console.error(error);
        return;
    }

    if (!data.length) {
        document.getElementById('profile-page').innerHTML = `
            <div style="padding:20px; font-size:18px;">Voc√™ ainda n√£o salvou nenhum rol√™.</div>
        `;
        return;
    }

    const html = data.map(route => {
        const thumb = route.photos?.[0]?.url || "";
        return `
            <div class="route-card">
                <img class="route-thumb" src="${thumb}">
                <div class="route-info">
                    <div class="route-title">Rol√™ ${route.route_id}</div>
                    <div class="route-date">${new Date(route.created_at).toLocaleString()}</div>
                </div>
            </div>
        `;
    }).join('');

    document.getElementById('profile-page').innerHTML = `
        <div class="route-list">${html}</div>
    `;
}
    </script>
</body>
</html>
