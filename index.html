<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>Rolezinho</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  /* Reset e base mobile-first */
  * {
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
  }
  
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    overscroll-behavior: none;
    -webkit-overflow-scrolling: touch;
    -webkit-text-size-adjust: 100%;
    touch-action: pan-x pan-y;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  }

  body {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  /* Mapa responsivo com safe areas */
  #map {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100vh;
    height: 100dvh;
    width: 100vw;
    z-index: 1;
    touch-action: none;
  }

  /* Popups do mapa otimizados */
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    padding: 8px;
  }

  .thumbnail {
    max-width: 200px;
    max-height: 200px;
    width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 8px 0;
    object-fit: cover;
  }

  /* Bottom bar mobile-first */
  #bottomBar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 12px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    z-index: 1000;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.3s ease;
  }

  #bottomBar.hidden {
    transform: translateY(100%);
  }

  /* Bot√µes otimizados para mobile */
  button {
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 12px;
    border: none;
    background: #0066ff;
    color: white;
    font-weight: 600;
    cursor: pointer;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
    transition: all 0.2s;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  button:active {
    transform: scale(0.95);
    opacity: 0.8;
  }

  button:disabled {
    opacity: 0.4;
    pointer-events: none;
  }

  .btn-secondary {
    background: #333;
    border: 1px solid #555;
  }

  .btn-icon {
    min-width: 44px;
    padding: 10px;
  }

  /* Modais fullscreen mobile */
  .modal-fullscreen {
    position: fixed;
    inset: 0;
    background: #000;
    color: white;
    z-index: 9999;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 24px;
    padding-top: calc(24px + env(safe-area-inset-top, 0px));
    padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  .modal-fullscreen.active {
    display: flex;
  }

  .modal-content {
    max-width: 500px;
    width: 100%;
    text-align: center;
  }

  h1 {
    font-size: clamp(32px, 8vw, 48px);
    margin: 0 0 16px;
    font-weight: 700;
  }

  h2 {
    font-size: clamp(28px, 6vw, 38px);
    margin: 0 0 12px;
    font-weight: 600;
  }

  p {
    font-size: clamp(16px, 4vw, 20px);
    line-height: 1.5;
    opacity: 0.9;
    margin: 12px 0;
  }

  /* Inputs otimizados para mobile */
  input[type="text"],
  input[type="email"],
  input[type="tel"] {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border-radius: 12px;
    border: 2px solid #333;
    background: #111;
    color: white;
    margin: 8px 0;
    -webkit-appearance: none;
    appearance: none;
  }

  input:focus {
    outline: none;
    border-color: #0066ff;
  }

  /* Profile modal adaptado */
  #profileModal {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    color: white;
    z-index: 9999;
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top, 0px));
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  #profileModal.active {
    display: block;
  }

  .profile-photo {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    margin: 16px auto;
    display: block;
  }

  .role-card {
    padding: 16px;
    background: #111;
    border: 1px solid #333;
    border-radius: 12px;
    margin: 12px 0;
  }

  .role-card h3 {
    margin: 0 0 8px;
    font-size: 18px;
  }

  .role-card .date {
    font-size: 14px;
    opacity: 0.7;
    margin-bottom: 12px;
  }

  .button-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .button-group button {
    flex: 1;
    min-width: 100px;
    font-size: 14px;
    padding: 10px 16px;
  }

  /* Story editor mobile */
  #storyEditor {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 9999;
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top, 0px));
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    flex-direction: column;
  }

  #storyEditor.active {
    display: flex;
  }

  #storyCanvasWrapper {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  #storyCanvas {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    border: 2px solid #333;
  }

  /* Loading spinner */
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top-color: #0066ff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Gestos e anima√ß√µes */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Landscape adjustments */
  @media (orientation: landscape) and (max-height: 500px) {
    h1 { font-size: 28px; }
    h2 { font-size: 24px; }
    p { font-size: 16px; }
    button { padding: 10px 16px; min-height: 40px; }
  }

  /* Hide file input */
  input[type="file"] {
    display: none;
  }
</style>
</head>
<body>

<!-- Onboarding Screens -->
<div id="onboarding" class="modal-fullscreen">
  <div class="modal-content">
    <h1>üó∫Ô∏è Bem-vindo ao Rolezinho</h1>
    <p>Crie mapas dos seus rol√™s a partir de suas fotos e v√≠deos</p>
    <button id="obNext1">Come√ßar</button>
  </div>
</div>

<div id="onboarding2" class="modal-fullscreen">
  <div class="modal-content">
    <h2>Como funciona</h2>
    <p>
      1Ô∏è‚É£ Envie suas fotos e v√≠deos<br><br>
      2Ô∏è‚É£ O mapa √© criado automaticamente<br><br>
      3Ô∏è‚É£ Compartilhe com seus amigos
    </p>
    <button id="obNext2">Continuar</button>
  </div>
</div>

<div id="onboarding3" class="modal-fullscreen">
  <div class="modal-content">
    <h2>Crie seu Perfil</h2>
    <input id="onPhone" type="tel" placeholder="Telefone" autocomplete="tel">
    <input id="onEmail" type="email" placeholder="Email" autocomplete="email">
    <input id="onName" type="text" placeholder="Seu nome" autocomplete="name">
    <input id="onUser" type="text" placeholder="@username" autocomplete="username">
    <button id="finishOnboarding">Concluir</button>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal">
  <button id="closeProfile" style="position: absolute; top: 20px; right: 20px; z-index: 10;">‚úï</button>
  
  <h2>Meu Perfil</h2>
  
  <img id="profilePhotoPreview" class="profile-photo" style="display: none;">
  
  <div style="margin: 20px 0;">
    <p><strong>Nome:</strong> <span id="profileName"></span></p>
    <p><strong>Username:</strong> <span id="profileUser"></span></p>
    <p><strong>Email:</strong> <span id="profileEmail"></span></p>
    <p><strong>Telefone:</strong> <span id="profilePhone"></span></p>
  </div>

  <label for="profilePhotoInput" style="display: inline-block; padding: 10px 20px; background: #333; border-radius: 8px; cursor: pointer; margin: 12px 0;">
    üì∑ Alterar foto de perfil
  </label>
  <input type="file" id="profilePhotoInput" accept="image/*">

  <h3 style="margin-top: 30px; margin-bottom: 16px;">Meus Rol√™s</h3>
  <div id="profileRoles"></div>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Bottom Bar -->
<div id="bottomBar">
  <input type="file" id="upload" multiple accept="image/*,video/*">
  
  <button id="uploadBtn" class="btn-secondary">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
      <path d="M12 2l4 4h-3v6h-2V6H8l4-4zm-7 14v4h14v-4h2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4h2z"/>
    </svg>
    Escolher M√≠dia
  </button>
  
  <button id="saveRoute" class="btn-secondary" style="display: none;">
    üíæ Salvar
  </button>
  
  <button id="openProfile" class="btn-icon btn-secondary">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
      <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/>
    </svg>
  </button>
  
  <button id="shareRoute" style="display: none;">
    üì§ Compartilhar
  </button>
</div>

<!-- Story Editor -->
<div id="storyEditor">
  <button id="closeStoryEditor" style="position: absolute; top: 20px; right: 20px; z-index: 10;">‚úï</button>
  <div id="storyCanvasWrapper">
    <canvas id="storyCanvas" width="1080" height="1920"></canvas>
  </div>
  <button id="exportStory">Exportar Story</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
// Aguardar carregar todos os scripts
window.addEventListener('load', function() {
  initApp();
});

function initApp() {
  // Configura√ß√£o mobile-first
  document.addEventListener('gesturestart', e => e.preventDefault());
  document.addEventListener('gesturechange', e => e.preventDefault());
  document.addEventListener('gestureend', e => e.preventDefault());

  // Mapa
  const map = L.map('map', {
  zoomControl: true,
  attributionControl: false,
  tap: true,
  touchZoom: true,
  scrollWheelZoom: false
}).setView([-27.5954, -48.5480], 13);

L.tileLayer('https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
  detectRetina: true,
  maxZoom: 19
}).addTo(map);

  // Vari√°veis globais
  let waypoints = [];
  let markers = [];
  let currentRoute = null;
  window.map = map; // Tornar acess√≠vel globalmente para fun√ß√µes onclick

  // Onboarding
  const ob1 = document.getElementById("onboarding");
  const ob2 = document.getElementById("onboarding2");
  const ob3 = document.getElementById("onboarding3");

  if (!localStorage.getItem("onboardingDone")) {
    ob1.classList.add("active");
  } else {
    autoloadSharedRole();
  }

  document.getElementById("obNext1").addEventListener("click", () => {
    ob1.classList.remove("active");
    ob2.classList.add("active");
  });

  document.getElementById("obNext2").addEventListener("click", () => {
    ob2.classList.remove("active");
    ob3.classList.add("active");
  });

  document.getElementById("finishOnboarding").addEventListener("click", () => {
    const name = document.getElementById("onName").value.trim();
    const user = document.getElementById("onUser").value.trim();
    const phone = document.getElementById("onPhone").value.trim();
    const email = document.getElementById("onEmail").value.trim();
    
    if (!name || !user || !phone || !email) {
      alert("Preencha todos os campos.");
      return;
    }
    
    localStorage.setItem("profileName", name);
    localStorage.setItem("profileUser", user);
    localStorage.setItem("profilePhone", phone);
    localStorage.setItem("profileEmail", email);
    localStorage.setItem("onboardingDone", "1");
    
    ob3.classList.remove("active");
    autoloadSharedRole();
  });

  // Autoload shared role
  function autoloadSharedRole() {
    const hash = window.location.hash.replace(/^#/, "");
    if (hash.length > 0) {
      try {
        const decodedJSON = LZString.decompressFromBase64(hash.replace(/-/g, "+").replace(/_/g, "/"));
        const decoded = JSON.parse(decodedJSON);
        // Mostrar interface de visualiza√ß√£o compartilhada
        showSharedRoleView(decoded);
      } catch (e) {
        console.error("Erro carregando rol√™ compartilhado:", e);
        alert("Erro ao carregar o rol√™ compartilhado. Link inv√°lido.");
      }
    }
  }

  function showSharedRoleView(roleData) {
    // Carregar waypoints no mapa
    loadRoleData(roleData.waypoints, roleData.titulo);
    
    // Criar header com info do rol√™
    const sharedHeader = document.createElement('div');
    sharedHeader.id = 'sharedHeader';
    sharedHeader.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 12px 16px;
      padding-top: calc(12px + env(safe-area-inset-top, 0px));
      z-index: 1001;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    `;
    
    const creatorName = roleData.creatorName || "Algu√©m";
    const creatorPhoto = roleData.creatorPhoto || "";
    
    sharedHeader.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px;">
        ${creatorPhoto ? `<img src="${creatorPhoto}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : `
          <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 20px;">
            üìç
          </div>
        `}
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 16px;">${roleData.titulo || "Rol√™"}</div>
          <div style="font-size: 13px; opacity: 0.7;">por ${creatorName}</div>
        </div>
        <button id="closeSharedView" style="background: transparent; border: none; color: white; font-size: 24px; padding: 4px 8px; min-height: auto;">‚úï</button>
      </div>
    `;
    
    document.body.appendChild(sharedHeader);
    
    // Ajustar mapa para n√£o ficar atr√°s do header
    const mapEl = document.getElementById('map');
    mapEl.style.paddingTop = '64px';
    
    // Esconder bottom bar
    const bottomBar = document.getElementById('bottomBar');
    bottomBar.style.display = 'none';
    
    // Bot√£o para fechar e criar pr√≥prio rol√™
    document.getElementById('closeSharedView').addEventListener('click', () => {
      const newUrl = window.location.origin + window.location.pathname;
      window.history.pushState({}, '', newUrl);
      sharedHeader.remove();
      mapEl.style.paddingTop = '0';
      bottomBar.style.display = 'flex';
      clearMap();
      map.setView([-27.5954, -48.5480], 13);
    });
  }

  // Upload de m√≠dias
  document.getElementById("uploadBtn").addEventListener("click", () => {
    document.getElementById("upload").click();
  });

  document.getElementById("upload").addEventListener("change", async (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    // Mostrar loading
    const loadingDiv = document.createElement('div');
    loadingDiv.innerHTML = '<div class="spinner"></div><p style="text-align:center; margin-top:10px;">Processando m√≠dias...</p>';
    loadingDiv.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9998; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white;';
    document.body.appendChild(loadingDiv);

    waypoints = [];
    clearMap();

    for (let file of files) {
      // Ignorar v√≠deos longos
      if (file.type.startsWith("video")) {
        const duration = await getVideoDuration(file);
        if (duration > 4) continue;
      }

      const exif = await window.exifr.gps(file);
      if (exif?.latitude && exif?.longitude) {
        const thumbnail = await fileToBase64(file);
        const ts = exif?.DateTimeOriginal || new Date(file.lastModified);
        
        waypoints.push({
          lat: exif.latitude,
          lon: exif.longitude,
          name: file.name,
          thumbnail,
          isVideo: file.type.startsWith("video"),
          ts
        });
      }
    }

    // Ordenar por timestamp
    waypoints.sort((a, b) => new Date(a.ts) - new Date(b.ts));

    // Renderizar no mapa
    renderWaypoints();
    
    document.body.removeChild(loadingDiv);
    document.getElementById("saveRoute").style.display = "inline-flex";
    
    e.target.value = '';
  });

  function clearMap() {
    markers = [];
    if (currentRoute) {
      map.removeLayer(currentRoute);
      currentRoute = null;
    }
    map.eachLayer(layer => {
      if (layer instanceof L.Marker) map.removeLayer(layer);
    });
  }

  function renderWaypoints() {
    clearMap();
    const bounds = [];

    waypoints.forEach((wp, i) => {
      const marker = L.marker([wp.lat, wp.lon]).addTo(map);
      markers.push(marker);

      const mediaHTML = wp.isVideo
        ? `<video src="${wp.thumbnail}" class="thumbnail" autoplay loop muted playsinline></video>`
        : `<img src="${wp.thumbnail}" class="thumbnail">`;

      marker.bindPopup(`
        <div style="text-align:center; min-width:200px;">
          <b>${wp.name}</b><br>
          ${mediaHTML}<br>
          <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
            <button onclick="window.focusMarker(${i - 1})" style="flex:1;">‚¨ÖÔ∏è</button>
            <button onclick="window.focusMarker(${i + 1})" style="flex:1;">‚û°Ô∏è</button>
          </div>
        </div>
      `);

      marker.on("click", () => {
        map.setView(marker.getLatLng(), 15, { animate: true });
      });

      bounds.push([wp.lat, wp.lon]);
    });

    if (bounds.length > 0) {
      map.once("moveend", () => {
        if (waypoints.length > 1) {
          const coords = waypoints.map(w => [w.lat, w.lon]);
          currentRoute = L.polyline(coords, {
            color: '#0066ff',
            weight: 3,
            opacity: 0.7
          }).addTo(map);
        }
      });
      
      map.flyToBounds(bounds, { 
        padding: [50, 50],
        maxZoom: 15,
        animate: true 
      });
    }
  }

  function loadRoleData(data, title = null) {
    waypoints = data;
    renderWaypoints();
    // Se √© um rol√™ compartilhado, n√£o mostrar bot√£o de compartilhar
    const isShared = window.location.hash.length > 1;
    if (!isShared) {
      document.getElementById("shareRoute").style.display = "inline-flex";
    }
  }

  // Expor focusMarker globalmente para os bot√µes onclick
  window.focusMarker = function(index) {
    if (!markers.length) return;
    const total = markers.length;
    const i = ((index % total) + total) % total;
    const m = markers[i];
    map.setView(m.getLatLng(), 15, { animate: true });
    m.openPopup();
  };

  // Salvar rol√™
  document.getElementById("saveRoute").addEventListener("click", async () => {
    if (!waypoints.length) {
      alert("Nenhum rol√™ para salvar.");
      return;
    }

    const title = prompt("D√™ um t√≠tulo ao seu rol√™:");
    if (!title) return;

    const compressed = await Promise.all(
      waypoints.map(async wp => ({
        lat: wp.lat,
        lon: wp.lon,
        name: wp.name,
        thumbnail: wp.isVideo ? wp.thumbnail : await compressImage(wp.thumbnail, 300),
        isVideo: wp.isVideo,
        ts: wp.ts
      }))
    );

    const saved = JSON.parse(localStorage.getItem("rolesSalvos") || "[]");
    const role = {
      id: Date.now(),
      titulo: title,
      data: new Date().toISOString(),
      waypoints: compressed
    };

    saved.push(role);
    localStorage.setItem("rolesSalvos", JSON.stringify(saved));
    
    alert("Rol√™ salvo com sucesso!");
    
    window.lastSavedRoleId = role.id;
    document.getElementById("shareRoute").style.display = "inline-flex";
    document.getElementById("saveRoute").disabled = true;
  });

  // Profile
  document.getElementById("openProfile").addEventListener("click", () => {
    document.getElementById("profileName").textContent = localStorage.getItem("profileName") || "‚Äî";
    document.getElementById("profileUser").textContent = "@" + (localStorage.getItem("profileUser") || "‚Äî");
    document.getElementById("profileEmail").textContent = localStorage.getItem("profileEmail") || "‚Äî";
    document.getElementById("profilePhone").textContent = localStorage.getItem("profilePhone") || "‚Äî";
    
    const photo = localStorage.getItem("profilePhoto");
    const preview = document.getElementById("profilePhotoPreview");
    if (photo) {
      preview.src = photo;
      preview.style.display = "block";
    }
    
    renderProfileRoles();
    document.getElementById("profileModal").classList.add("active");
  });

  document.getElementById("closeProfile").addEventListener("click", () => {
    document.getElementById("profileModal").classList.remove("active");
  });

  document.getElementById("profilePhotoInput").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const base64 = await fileToBase64(file);
    localStorage.setItem("profilePhoto", base64);
    
    const preview = document.getElementById("profilePhotoPreview");
    preview.src = base64;
    preview.style.display = "block";
  });

  function renderProfileRoles() {
    const saved = JSON.parse(localStorage.getItem("rolesSalvos") || "[]");
    const html = saved.map(r => `
      <div class="role-card">
        <h3>${r.titulo}</h3>
        <div class="date">${new Date(r.data).toLocaleDateString('pt-BR')}</div>
        <div class="button-group">
          <button onclick="window.loadRole(${r.id})" class="btn-secondary">Abrir</button>
          <button onclick="window.compartilharRole(${r.id})">Compartilhar</button>
        </div>
      </div>
    `).join("");
    
    document.getElementById("profileRoles").innerHTML = html || '<p style="text-align:center; opacity:0.5;">Nenhum rol√™ salvo ainda</p>';
  }

  window.loadRole = function(id) {
    const saved = JSON.parse(localStorage.getItem("rolesSalvos") || "[]");
    const role = saved.find(r => r.id === id);
    if (!role) return;
    
    document.getElementById("profileModal").classList.remove("active");
    loadRoleData(role.waypoints);
    window.currentOpenedRoleId = id;
  };

  // Compartilhar
  document.getElementById("shareRoute").addEventListener("click", () => {
    const id = window.lastSavedRoleId || window.currentOpenedRoleId;
    if (id) window.compartilharRole(id);
  });

  window.compartilharRole = function(id) {
    const saved = JSON.parse(localStorage.getItem("rolesSalvos") || "[]");
    const role = saved.find(r => r.id === id);
    if (!role) return;

    // Adicionar informa√ß√µes do criador
    const payload = {
      titulo: role.titulo,
      waypoints: role.waypoints,
      creatorName: localStorage.getItem("profileName") || "An√¥nimo",
      creatorPhoto: localStorage.getItem("profilePhoto") || null,
      creatorUser: localStorage.getItem("profileUser") || null,
      createdAt: role.data
    };

    // Compress payload into a SHORT hash
    const json = JSON.stringify(payload);
    const compressed = LZString.compressToBase64(json)
      .replace(/\+/g, "-")
      .replace(/\//g, "_")
      .replace(/=+$/, "");

    // Base URL always GitHub Pages‚Äìsafe
    let base = window.location.origin + window.location.pathname;
    base = base.replace(/index\.html$/i, "");
    base = base.replace(/\/+$/, "");

    const shareURL = `${base}/#${compressed}`;

    if (navigator.share) {
      navigator.share({
        title: `Rol√™: ${role.titulo}`,
        text: `Confira meu rol√™ "${role.titulo}" no mapa! üó∫Ô∏è`,
        url: shareURL
      }).catch(err => console.log('Erro ao compartilhar:', err));
    } else {
      navigator.clipboard.writeText(shareURL).then(() => {
        // Mostrar modal de sucesso com preview
        showShareSuccessModal(shareURL, role.titulo);
      });
    }
  };

  function showShareSuccessModal(url, titulo) {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 24px;
      color: white;
      text-align: center;
    `;
    
    modal.innerHTML = `
      <div style="max-width: 400px; width: 100%;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
        <h2 style="margin: 0 0 12px; font-size: 24px;">Link Copiado!</h2>
        <p style="opacity: 0.8; margin-bottom: 24px;">
          Seu rol√™ "${titulo}" est√° pronto para ser compartilhado!
        </p>
        
        <div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 16px; margin-bottom: 24px; word-break: break-all; font-size: 12px; font-family: monospace;">
          ${url}
        </div>
        
        <p style="opacity: 0.7; font-size: 14px; margin-bottom: 24px;">
          Cole e envie este link para seus amigos. Eles poder√£o visualizar seu rol√™ no mapa! üó∫Ô∏è
        </p>
        
        <button id="closeShareModal" style="width: 100%; padding: 14px; background: #0066ff; border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600;">
          Entendi
        </button>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('closeShareModal').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }

  // Helper functions
  function getBaseURL() {
    let base = window.location.origin + window.location.pathname;
    if (base.endsWith("index.html")) {
      base = base.replace("index.html", "");
    }
    base = base.replace(/\/+$/, "");
    return base;
  }
  async function fileToBase64(file) {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }

  async function getVideoDuration(file) {
    return new Promise(resolve => {
      const video = document.createElement('video');
      video.preload = 'metadata';
      video.onloadedmetadata = () => {
        URL.revokeObjectURL(video.src);
        resolve(video.duration);
      };
      video.src = URL.createObjectURL(file);
    });
  }

  async function compressImage(base64, maxWidth = 300) {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const scale = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.7));
      };
      img.src = base64;
    });
  }

  // Gest√£o de teclado virtual
  let keyboardOpen = false;
  ['focus', 'blur'].forEach(event => {
    document.addEventListener(event, e => {
      if (e.target.matches('input, textarea')) {
        keyboardOpen = event === 'focus';
        document.documentElement.classList.toggle('keyboard-open', keyboardOpen);
      }
    }, true);
  });

  // Prevent bounce scroll
  document.body.addEventListener('touchmove', e => {
    if (e.target.closest('#map')) return;
    if (!e.target.closest('.modal-fullscreen, #profileModal')) {
      e.preventDefault();
    }
  }, { passive: false });

  console.log('Rolezinho mobile-first loaded ‚úÖ');
}
</script>

</body>
</html>
